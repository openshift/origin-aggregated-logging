!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vega-util"),require("vega-dataflow"),require("vega-statistics"),require("d3-array")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-dataflow","vega-statistics","d3-array"],e):e((t.vega=t.vega||{},t.vega.transforms=t.vega.transforms||{}),t.vega,t.vega,t.vega,t.d3)}(this,function(t,e,i,n,a){"use strict";function r(t){return t&&t.length?1===t.length?t[0]:(e=t,function(t){for(var i=e.length,n=1,a=String(e[0](t));n<i;++n)a+="|"+e[n](t);return a}):function(){return""};var e}function s(t,e,i){return i||t+(e?"_"+e:"")}var u={values:f({name:"values",init:"cell.store = true;",set:"cell.data.values()",idx:-1}),count:f({name:"count",set:"cell.num"}),__count__:f({name:"count",set:"this.missing + this.valid"}),missing:f({name:"missing",set:"this.missing"}),valid:f({name:"valid",set:"this.valid"}),sum:f({name:"sum",init:"this.sum = 0;",add:"this.sum += v;",rem:"this.sum -= v;",set:"this.sum"}),mean:f({name:"mean",init:"this.mean = 0;",add:"var d = v - this.mean; this.mean += d / this.valid;",rem:"var d = v - this.mean; this.mean -= this.valid ? d / this.valid : this.mean;",set:"this.mean"}),average:f({name:"average",set:"this.mean",req:["mean"],idx:1}),variance:f({name:"variance",init:"this.dev = 0;",add:"this.dev += d * (v - this.mean);",rem:"this.dev -= d * (v - this.mean);",set:"this.valid > 1 ? this.dev / (this.valid-1) : 0",req:["mean"],idx:1}),variancep:f({name:"variancep",set:"this.valid > 1 ? this.dev / this.valid : 0",req:["variance"],idx:2}),stdev:f({name:"stdev",set:"this.valid > 1 ? Math.sqrt(this.dev / (this.valid-1)) : 0",req:["variance"],idx:2}),stdevp:f({name:"stdevp",set:"this.valid > 1 ? Math.sqrt(this.dev / this.valid) : 0",req:["variance"],idx:2}),stderr:f({name:"stderr",set:"this.valid > 1 ? Math.sqrt(this.dev / (this.valid * (this.valid-1))) : 0",req:["variance"],idx:2}),distinct:f({name:"distinct",set:"cell.data.distinct(this.get)",req:["values"],idx:3}),ci0:f({name:"ci0",set:"cell.data.ci0(this.get)",req:["values"],idx:3}),ci1:f({name:"ci1",set:"cell.data.ci1(this.get)",req:["values"],idx:3}),median:f({name:"median",set:"cell.data.q2(this.get)",req:["values"],idx:3}),q1:f({name:"q1",set:"cell.data.q1(this.get)",req:["values"],idx:3}),q3:f({name:"q3",set:"cell.data.q3(this.get)",req:["values"],idx:3}),argmin:f({name:"argmin",init:"this.argmin = null;",add:"if (v < this.min) this.argmin = t;",rem:"if (v <= this.min) this.argmin = null;",set:"this.argmin || cell.data.argmin(this.get)",req:["min"],str:["values"],idx:3}),argmax:f({name:"argmax",init:"this.argmax = null;",add:"if (v > this.max) this.argmax = t;",rem:"if (v >= this.max) this.argmax = null;",set:"this.argmax || cell.data.argmax(this.get)",req:["max"],str:["values"],idx:3}),min:f({name:"min",init:"this.min = null;",add:"if (v < this.min || this.min === null) this.min = v;",rem:"if (v <= this.min) this.min = NaN;",set:"this.min = (isNaN(this.min) ? cell.data.min(this.get) : this.min)",str:["values"],idx:4}),max:f({name:"max",init:"this.max = null;",add:"if (v > this.max || this.max === null) this.max = v;",rem:"if (v >= this.max) this.max = NaN;",set:"this.max = (isNaN(this.max) ? cell.data.max(this.get) : this.max)",str:["values"],idx:4})},o=Object.keys(u);function l(t,e){return u[t](e)}function f(t){return function(i){var n=e.extend({init:"",add:"",rem:"",idx:0},t);return n.out=i||t.name,n}}function d(t,e){return t.idx-e.idx}function m(t,i){var n=i||e.identity,a=function(t,e){var i,n=t.reduce(function t(i,n){function a(e){i[e]||t(i,i[e]=u[e]())}return n.req&&n.req.forEach(a),e&&n.str&&n.str.forEach(a),i},t.reduce(function(t,e){return t[e.name]=e,t},{})),a=[];for(i in n)a.push(n[i]);return a.sort(d)}(t,!0),r="var cell = this.cell; this.valid = 0; this.missing = 0;",s="this.cell = cell; this.init();",o="if(v==null){++this.missing; return;} if(v!==v) return; ++this.valid;",l="if(v==null){--this.missing; return;} if(v!==v) return; --this.valid;",f="var cell = this.cell;";return a.forEach(function(t){r+=t.init,o+=t.add,l+=t.rem}),t.slice().sort(d).forEach(function(t){f+="t['"+t.out+"']="+t.set+";"}),f+="return t;",(s=Function("cell",s)).prototype.init=Function(r),s.prototype.add=Function("v","t",o),s.prototype.rem=Function("v","t",l),s.prototype.set=Function("t",f),s.prototype.get=n,s.fields=t.map(function(t){return t.out}),s}function h(t){this._key=t?e.field(t):i.tupleid,this.reset()}var c=h.prototype;function p(t){i.Transform.call(this,null,t),this._adds=[],this._mods=[],this._alen=0,this._mlen=0,this._drop=!0,this._cross=!1,this._dims=[],this._dnames=[],this._measures=[],this._countOnly=!1,this._counts=null,this._prev=null,this._inputs=null,this._outputs=null}c.reset=function(){this._add=[],this._rem=[],this._ext=null,this._get=null,this._q=null},c.add=function(t){this._add.push(t)},c.rem=function(t){this._rem.push(t)},c.values=function(){if(this._get=null,0===this._rem.length)return this._add;var t,e,i,n=this._add,a=this._rem,r=this._key,s=n.length,u=a.length,o=Array(s-u),l={};for(t=0;t<u;++t)l[r(a[t])]=1;for(t=0,e=0;t<s;++t)l[r(i=n[t])]?l[r(i)]=0:o[e++]=i;return this._rem=[],this._add=o},c.distinct=function(t){for(var e,i=this.values(),n=i.length,a={},r=0;--n>=0;)e=t(i[n])+"",a.hasOwnProperty(e)||(a[e]=1,++r);return r},c.extent=function(t){if(this._get!==t||!this._ext){var i=this.values(),n=e.extentIndex(i,t);this._ext=[i[n[0]],i[n[1]]],this._get=t}return this._ext},c.argmin=function(t){return this.extent(t)[0]||{}},c.argmax=function(t){return this.extent(t)[1]||{}},c.min=function(t){var e=this.extent(t)[0];return null!=e?t(e):1/0},c.max=function(t){var e=this.extent(t)[1];return null!=e?t(e):-1/0},c.quartile=function(t){return this._get===t&&this._q||(this._q=n.quartiles(this.values(),t),this._get=t),this._q},c.q1=function(t){return this.quartile(t)[0]},c.q2=function(t){return this.quartile(t)[1]},c.q3=function(t){return this.quartile(t)[2]},c.ci=function(t){return this._get===t&&this._ci||(this._ci=n.bootstrapCI(this.values(),1e3,.05,t),this._get=t),this._ci},c.ci0=function(t){return this.ci(t)[0]},c.ci1=function(t){return this.ci(t)[1]},p.Definition={type:"Aggregate",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:o},{name:"fields",type:"field",null:!0,array:!0},{name:"as",type:"string",null:!0,array:!0},{name:"drop",type:"boolean",default:!0},{name:"cross",type:"boolean",default:!1},{name:"key",type:"field"}]};var v=e.inherits(p,i.Transform);function g(t){i.Transform.call(this,null,t)}v.transform=function(t,e){var i,n=this,a=e.fork(e.NO_SOURCE|e.NO_FIELDS);return this.stamp=a.stamp,this.value&&((i=t.modified())||e.modified(this._inputs))?(this._prev=this.value,this.value=i?this.init(t):{},e.visit(e.SOURCE,function(t){n.add(t)})):(this.value=this.value||this.init(t),e.visit(e.REM,function(t){n.rem(t)}),e.visit(e.ADD,function(t){n.add(t)})),a.modifies(this._outputs),n._drop=!1!==t.drop,t.cross&&n._dims.length>1&&(n._drop=!1,this.cross()),n.changes(a)},v.cross=function(){var t=this,e=t.value,i=t._dnames,n=i.map(function(){return{}}),a=i.length;function r(t){var e,r,s,u;for(e in t)for(s=t[e].tuple,r=0;r<a;++r)n[r][u=s[i[r]]]=u}r(t._prev),r(e),function r(s,u,o){var l,f,d=i[o],m=n[o++];for(l in m)u[d]=m[l],f=s?s+"|"+l:l,o<a?r(f,u,o):e[f]||t.cell(f,u)}("",{},0)},v.init=function(t){var i=this._inputs=[],n=this._outputs=[],a={};function u(t){for(var n,r=e.array(e.accessorFields(t)),s=0,u=r.length;s<u;++s)a[n=r[s]]||(a[n]=1,i.push(n))}this._dims=e.array(t.groupby),this._dnames=this._dims.map(function(t){var i=e.accessorName(t);return u(t),n.push(i),i}),this.cellkey=t.key?t.key:r(this._dims),this._countOnly=!0,this._counts=[],this._measures=[];var o,f,d,h,c,p,v=t.fields||[null],g=t.ops||["count"],y=t.as||[],_=v.length,x={};for(_!==g.length&&e.error("Unmatched number of fields and aggregate ops."),p=0;p<_;++p)o=v[p],f=g[p],null==o&&"count"!==f&&e.error("Null aggregate field specified."),c=s(f,h=e.accessorName(o),y[p]),n.push(c),"count"!==f?((d=x[h])||(u(o),(d=x[h]=[]).field=o,this._measures.push(d)),"count"!==f&&(this._countOnly=!1),d.push(l(f,c))):this._counts.push(c);return this._measures=this._measures.map(function(t){return m(t,t.field)}),{}},v.cellkey=r(),v.cell=function(t,e){var i=this.value[t];return i?0===i.num&&this._drop&&i.stamp<this.stamp?(i.stamp=this.stamp,this._adds[this._alen++]=i):i.stamp<this.stamp&&(i.stamp=this.stamp,this._mods[this._mlen++]=i):(i=this.value[t]=this.newcell(t,e),this._adds[this._alen++]=i),i},v.newcell=function(t,e){var i={key:t,num:0,agg:null,tuple:this.newtuple(e,this._prev&&this._prev[t]),stamp:this.stamp,store:!1};if(!this._countOnly){var n,a=this._measures,r=a.length;for(i.agg=Array(r),n=0;n<r;++n)i.agg[n]=new a[n](i)}return i.store&&(i.data=new h),i},v.newtuple=function(t,e){var n,a,r=this._dnames,s=this._dims,u={};for(n=0,a=s.length;n<a;++n)u[r[n]]=s[n](t);return e?i.replace(e.tuple,u):i.ingest(u)},v.add=function(t){var e,i,n,a=this.cellkey(t),r=this.cell(a,t);if(r.num+=1,!this._countOnly)for(r.store&&r.data.add(t),i=0,n=(e=r.agg).length;i<n;++i)e[i].add(e[i].get(t),t)},v.rem=function(t){var e,i,n,a=this.cellkey(t),r=this.cell(a,t);if(r.num-=1,!this._countOnly)for(r.store&&r.data.rem(t),i=0,n=(e=r.agg).length;i<n;++i)e[i].rem(e[i].get(t),t)},v.celltuple=function(t){var e,i,n,a=t.tuple,r=this._counts;for(t.store&&t.data.values(),i=0,n=r.length;i<n;++i)a[r[i]]=t.num;if(!this._countOnly)for(i=0,n=(e=t.agg).length;i<n;++i)e[i].set(a);return a},v.changes=function(t){var e,i,n,a,r=this._adds,s=this._mods,u=this._prev,o=this._drop,l=t.add,f=t.rem,d=t.mod;if(u)for(i in u)e=u[i],o&&!e.num||f.push(e.tuple);for(n=0,a=this._alen;n<a;++n)l.push(this.celltuple(r[n])),r[n]=null;for(n=0,a=this._mlen;n<a;++n)(0===(e=s[n]).num&&o?f:d).push(this.celltuple(e)),s[n]=null;return this._alen=this._mlen=0,this._prev=null,t},g.Definition={type:"Bin",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"anchor",type:"number"},{name:"maxbins",type:"number",default:20},{name:"base",type:"number",default:10},{name:"divide",type:"number",array:!0,default:[5,2]},{name:"extent",type:"number",array:!0,length:2,required:!0},{name:"step",type:"number"},{name:"steps",type:"number",array:!0},{name:"minstep",type:"number",default:0},{name:"nice",type:"boolean",default:!0},{name:"name",type:"string"},{name:"as",type:"string",array:!0,length:2,default:["bin0","bin1"]}]};var y=e.inherits(g,i.Transform);y.transform=function(t,i){var n,a=this._bins(t),r=a.start,s=a.step,u=t.as||["bin0","bin1"],o=u[0],l=u[1];return n=t.modified()?(i=i.reflow(!0)).SOURCE:i.modified(e.accessorFields(t.field))?i.ADD_MOD:i.ADD,i.visit(n,function(t){var e=a(t);t[o]=e,t[l]=null==e?null:r+s*(1+(e-r)/s)}),i.modifies(u)},y._bins=function(t){if(this.value&&!t.modified())return this.value;var i,a,r=t.field,s=n.bin(t),u=s.start,o=s.stop,l=s.step;null!=(i=t.anchor)&&(a=i-(u+l*Math.floor((i-u)/l)),u+=a,o+=a);var f=function(t){var e=r(t);return null==e?null:(e=Math.max(u,Math.min(+e,o-l)),u+l*Math.floor((e-u)/l))};return f.start=u,f.stop=o,f.step=l,this.value=e.accessor(f,e.accessorFields(r),t.name||"bin_"+e.accessorName(r))};var _=function(t,i,n){var a=t,r=i||[],s=n||[],u={},o=0;return{add:function(t){s.push(t)},remove:function(t){u[a(t)]=++o},size:function(){return r.length},data:function(t,i){return o&&(r=r.filter(function(t){return!u[a(t)]}),u={},o=0),i&&t&&r.sort(t),s.length&&(r=t?e.merge(t,r,s.sort(t)):r.concat(s),s=[]),r}}};function x(t){i.Transform.call(this,[],t)}function O(t){i.Operator.call(this,null,D,t)}function D(t){return this.value&&!t.modified()?this.value:e.compare(t.fields,t.orders)}function b(t){i.Transform.call(this,null,t)}x.Definition={type:"Collect",metadata:{source:!0},params:[{name:"sort",type:"compare"}]},e.inherits(x,i.Transform).transform=function(t,e){var n=e.fork(e.ALL),a=_(i.tupleid,this.value,n.materialize(n.ADD).add),r=t.sort,s=e.changed()||r&&(t.modified("sort")||e.modified(r.fields));return n.visit(n.REM,a.remove),this.modified(s),this.value=n.source=a.data(r,s),e.source&&e.source.root&&(this.value.root=e.source.root),n},e.inherits(O,i.Operator),b.Definition={type:"CountPattern",metadata:{generates:!0,changes:!0},params:[{name:"field",type:"field",required:!0},{name:"case",type:"enum",values:["upper","lower","mixed"],default:"mixed"},{name:"pattern",type:"string",default:'[\\w"]+'},{name:"stopwords",type:"string",default:""},{name:"as",type:"string",array:!0,length:2,default:["text","count"]}]};var E=e.inherits(b,i.Transform);function k(t){i.Transform.call(this,null,t)}E.transform=function(t,e){function i(e){return function(i){for(var n,a=function(t,e,i){switch(e){case"upper":t=t.toUpperCase();break;case"lower":t=t.toLowerCase()}return t.match(i)}(u(i),t.case,r)||[],o=0,l=a.length;o<l;++o)s.test(n=a[o])||e(n)}}var n=this._parameterCheck(t,e),a=this._counts,r=this._match,s=this._stop,u=t.field,o=t.as||["text","count"],l=i(function(t){a[t]=1+(a[t]||0)}),f=i(function(t){a[t]-=1});return n?e.visit(e.SOURCE,l):(e.visit(e.ADD,l),e.visit(e.REM,f)),this._finish(e,o)},E._parameterCheck=function(t,e){var i=!1;return!t.modified("stopwords")&&this._stop||(this._stop=new RegExp("^"+(t.stopwords||"")+"$","i"),i=!0),!t.modified("pattern")&&this._match||(this._match=new RegExp(t.pattern||"[\\w']+","g"),i=!0),(t.modified("field")||e.modified(t.field.fields))&&(i=!0),i&&(this._counts={}),i},E._finish=function(t,e){var n,a,r,s=this._counts,u=this._tuples||(this._tuples={}),o=e[0],l=e[1],f=t.fork(t.NO_SOURCE|t.NO_FIELDS);for(n in s)a=u[n],r=s[n]||0,!a&&r?(u[n]=a=i.ingest({}),a[o]=n,a[l]=r,f.add.push(a)):0===r?(a&&f.rem.push(a),s[n]=null,u[n]=null):a[l]!==r&&(a[l]=r,f.mod.push(a));return f.modifies(e)},k.Definition={type:"Cross",metadata:{generates:!0},params:[{name:"filter",type:"expr"},{name:"as",type:"string",array:!0,length:2,default:["a","b"]}]},e.inherits(k,i.Transform).transform=function(t,n){var a=n.fork(n.NO_SOURCE),r=this.value,s=t.as||["a","b"],u=s[0],o=s[1];return!r||n.changed(n.ADD_REM)||t.modified("as")||t.modified("filter")?(r&&(a.rem=r),r=n.materialize(n.SOURCE).source,a.add=this.value=function(t,e,n,a){for(var r,s,u=[],o={},l=t.length,f=0;f<l;++f)for(o[e]=s=t[f],r=0;r<l;++r)o[n]=t[r],a(o)&&(u.push(i.ingest(o)),(o={})[e]=s);return u}(r,u,o,t.filter||e.truthy)):a.mod=r,a.source=this.value,a.modifies(s)};var q={kde:n.randomKDE,mixture:n.randomMixture,normal:n.randomNormal,uniform:n.randomUniform},w="distributions",T="function",N="field";function R(t){i.Transform.call(this,null,t)}var M=[{key:{function:"normal"},params:[{name:"mean",type:"number",default:0},{name:"stdev",type:"number",default:1}]},{key:{function:"uniform"},params:[{name:"min",type:"number",default:0},{name:"max",type:"number",default:1}]},{key:{function:"kde"},params:[{name:"field",type:"field",required:!0},{name:"from",type:"data"},{name:"bandwidth",type:"number",default:0}]}],S={key:{function:"mixture"},params:[{name:"distributions",type:"param",array:!0,params:M},{name:"weights",type:"number",array:!0}]};function C(t){i.Transform.call(this,[1/0,-1/0],t)}function A(t,e){i.Operator.call(this,t),this.parent=e}R.Definition={type:"Density",metadata:{generates:!0},params:[{name:"extent",type:"number",array:!0,length:2},{name:"steps",type:"number",default:100},{name:"method",type:"string",default:"pdf",values:["pdf","cdf"]},{name:"distribution",type:"param",params:M.concat(S)},{name:"as",type:"string",array:!0,default:["value","density"]}]},e.inherits(R,i.Transform).transform=function(t,n){var r,s=n.fork(n.NO_SOURCE|n.NO_FIELDS);if(!this.value||n.changed()||t.modified()){var u=function t(i,n){var a=i[T];q.hasOwnProperty(a)||e.error("Unknown distribution function: "+a);var r=q[a]();for(var s in i)s===N?r.data((i.from||n()).map(i[s])):s===w?r[s](i[s].map(function(e){return t(e,n)})):typeof r[s]===T&&r[s](i[s]);return r}(t.distribution,(r=n,function(){return r.materialize(r.SOURCE).source})),o=t.method||"pdf";"pdf"!==o&&"cdf"!==o&&e.error("Invalid density method: "+o),t.extent||u.data||e.error("Missing density extent parameter."),o=u[o];var l=t.as||["value","density"],f=t.extent||a.extent(u.data()),d=(f[1]-f[0])/(t.steps||100),m=a.range(f[0],f[1]+d/2,d).map(function(t){var e={};return e[l[0]]=t,e[l[1]]=o(t),i.ingest(e)});this.value&&(s.rem=this.value),this.value=s.add=s.source=m}return s},C.Definition={type:"Extent",metadata:{},params:[{name:"field",type:"field",required:!0}]},e.inherits(C,i.Transform).transform=function(t,e){var i=this.value,n=t.field,a=i[0],r=i[1],s=e.ADD;(e.changed()||e.modified(n.fields)||t.modified("field"))&&(s=e.SOURCE,a=1/0,r=-1/0),e.visit(s,function(t){var e=n(t);null!=e&&((e=+e)<a&&(a=e),e>r&&(r=e))}),this.value=[a,r]};var U=e.inherits(A,i.Operator);function F(t){i.Transform.call(this,{},t),this._keys=e.fastmap();var n=this._targets=[];n.active=0,n.forEach=function(t){for(var e=0,i=n.active;e<i;++e)t(n[e],e,n)}}U.connect=function(t){return this.targets().add(t),t.source=this},U.add=function(t){this.value.add.push(t)},U.rem=function(t){this.value.rem.push(t)},U.mod=function(t){this.value.mod.push(t)},U.init=function(t){this.value.init(t,t.NO_SOURCE)},U.evaluate=function(){return this.value};var z=e.inherits(F,i.Transform);function L(t){i.Operator.call(this,null,P,t)}function P(t){return this.value&&!t.modified()?this.value:e.isArray(t.name)?e.array(t.name).map(function(t){return e.field(t)}):e.field(t.name,t.as)}function I(t){i.Transform.call(this,e.fastmap(),t)}function j(t,i){return t?t.map(function(t,n){return i[n]||e.accessorName(t)}):null}function W(t){i.Transform.call(this,[],t)}function B(t){i.Transform.call(this,[],t)}function J(t){i.Transform.call(this,null,t)}function K(t){i.Transform.call(this,[],t)}z.activate=function(t){this._targets[this._targets.active++]=t},z.subflow=function(t,e,i,n){var a,r,s=this.value,u=s.hasOwnProperty(t)&&s[t];return u?u.value.stamp<i.stamp&&(u.init(i),this.activate(u)):(r=n||(r=this._group[t])&&r.tuple,u=(a=i.dataflow).add(new A(i.fork(i.NO_SOURCE),this)).connect(e(a,t,r)),s[t]=u,this.activate(u)),u},z.transform=function(t,e){var n=e.dataflow,a=this,r=t.key,s=t.subflow,u=this._keys,o=t.modified("key");function l(t){return a.subflow(t,s,e)}return this._group=t.group||{},this._targets.active=0,e.visit(e.REM,function(t){var e=i.tupleid(t),n=u.get(e);void 0!==n&&(u.delete(e),l(n).rem(t))}),e.visit(e.ADD,function(t){var e=r(t);u.set(i.tupleid(t),e),l(e).add(t)}),o||e.modified(r.fields)?e.visit(e.MOD,function(t){var e=i.tupleid(t),n=u.get(e),a=r(t);n===a?l(a).mod(t):(u.set(e,a),l(n).rem(t),l(a).add(t))}):e.changed(e.MOD)&&e.visit(e.MOD,function(t){l(u.get(i.tupleid(t))).mod(t)}),o&&e.visit(e.REFLOW,function(t){var e=i.tupleid(t),n=u.get(e),a=r(t);n!==a&&(u.set(e,a),l(n).rem(t),l(a).add(t))}),u.empty>n.cleanThreshold&&n.runAfter(u.clean),e},e.inherits(L,i.Operator),I.Definition={type:"Filter",metadata:{changes:!0},params:[{name:"expr",type:"expr",required:!0}]},e.inherits(I,i.Transform).transform=function(t,e){var n=e.dataflow,a=this.value,r=e.fork(),s=r.add,u=r.rem,o=r.mod,l=t.expr,f=!0;function d(e){var n=i.tupleid(e),r=l(e,t),d=a.get(n);r&&d?(a.delete(n),s.push(e)):r||d?f&&r&&!d&&o.push(e):(a.set(n,1),u.push(e))}return e.visit(e.REM,function(t){var e=i.tupleid(t);a.has(e)?a.delete(e):u.push(t)}),e.visit(e.ADD,function(e){l(e,t)?s.push(e):a.set(i.tupleid(e),1)}),e.visit(e.MOD,d),t.modified()&&(f=!1,e.visit(e.REFLOW,d)),a.empty>n.cleanThreshold&&n.runAfter(a.clean),r},W.Definition={type:"Flatten",metadata:{generates:!0},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0}]},e.inherits(W,i.Transform).transform=function(t,e){var n=e.fork(e.NO_SOURCE),a=t.fields,r=j(a,t.as||[]),s=r.length;return n.rem=this.value,e.visit(e.SOURCE,function(t){for(var e,u,o,l=a.map(function(e){return e(t)}),f=l.reduce(function(t,e){return Math.max(t,e.length)},0),d=0;d<f;++d){for(u=i.derive(t),e=0;e<s;++e)u[r[e]]=null==(o=l[e][d])?null:o;n.add.push(u)}}),this.value=n.source=n.add,n.modifies(r)},B.Definition={type:"Fold",metadata:{generates:!0},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0,length:2,default:["key","value"]}]},e.inherits(B,i.Transform).transform=function(t,n){var a=n.fork(n.NO_SOURCE),r=t.fields,s=r.map(e.accessorName),u=t.as||["key","value"],o=u[0],l=u[1],f=r.length;return a.rem=this.value,n.visit(n.SOURCE,function(t){for(var e,n=0;n<f;++n)(e=i.derive(t))[o]=s[n],e[l]=r[n](t),a.add.push(e)}),this.value=a.source=a.add,a.modifies(u)},J.Definition={type:"Formula",metadata:{modifies:!0},params:[{name:"expr",type:"expr",required:!0},{name:"as",type:"string",required:!0},{name:"initonly",type:"boolean"}]},e.inherits(J,i.Transform).transform=function(t,e){var i=t.expr,n=t.as,a=t.modified(),r=t.initonly?e.ADD:a?e.SOURCE:e.modified(i.fields)?e.ADD_MOD:e.ADD;return a&&(e=e.materialize().reflow(!0)),t.initonly||e.modifies(n),e.visit(r,function(e){e[n]=i(e,t)})},e.inherits(K,i.Transform).transform=function(t,e){var n,a,r,s=this.value,u=e.fork(e.ALL),o=t.size-s.length,l=t.generator;if(o>0){for(n=[];--o>=0;)n.push(r=i.ingest(l(t))),s.push(r);u.add=u.add.length?u.materialize(u.ADD).add.concat(n):n}else a=s.slice(0,-o),u.rem=u.rem.length?u.materialize(u.REM).rem.concat(a):a,s=s.slice(-o);return u.source=this.value=s,u};var $={value:"value",median:a.median,mean:a.mean,min:a.min,max:a.max},G=[];function H(t){i.Transform.call(this,[],t)}function Q(t){p.call(this,t)}H.Definition={type:"Impute",metadata:{changes:!0},params:[{name:"field",type:"field",required:!0},{name:"key",type:"field",required:!0},{name:"keyvals",array:!0},{name:"groupby",type:"field",array:!0},{name:"method",type:"enum",default:"value",values:["value","mean","median","max","min"]},{name:"value",default:0}]},e.inherits(H,i.Transform).transform=function(t,n){var a,r,s,u,o,l,f,d,m,h,c,p=n.fork(n.ALL),v=function(t){var i,n=t.method||$.value;if(null!=$[n])return n===$.value?(i=void 0!==t.value?t.value:0,function(){return i}):$[n];e.error("Unrecognized imputation method: "+n)}(t),g=(c=t.field,function(t){return t?c(t):NaN}),y=e.accessorName(t.field),_=e.accessorName(t.key),x=(t.groupby||[]).map(e.accessorName),O=function(t,e,i,n){var a,r,s,u,o,l,f,d,m=function(t){return t(d)},h=[],c=n?n.slice():[],p={},v={};for(c.forEach(function(t,e){p[t]=e+1}),u=0,f=t.length;u<f;++u)d=t[u],l=i(d),o=p[l]||(p[l]=c.push(l)),r=(a=e?e.map(m):G)+"",(s=v[r])||(s=v[r]=[],h.push(s),s.values=a),s[o-1]=d;return h.domain=c,h}(n.source,t.groupby,t.key,t.keyvals),D=[],b=this.value,E=O.domain.length;for(o=0,d=O.length;o<d;++o)for(s=(a=O[o]).values,r=NaN,f=0;f<E;++f)if(null==a[f]){for(u=O.domain[f],h={_impute:!0},l=0,m=s.length;l<m;++l)h[x[l]]=s[l];h[_]=u,h[y]=isNaN(r)?r=v(a,g):r,D.push(i.ingest(h))}return D.length&&(p.add=p.materialize(p.ADD).add.concat(D)),b.length&&(p.rem=p.materialize(p.REM).rem.concat(b)),this.value=D,p},Q.Definition={type:"JoinAggregate",metadata:{modifies:!0},params:[{name:"groupby",type:"field",array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"ops",type:"enum",array:!0,values:o},{name:"as",type:"string",null:!0,array:!0},{name:"key",type:"field"}]};var V=e.inherits(Q,p);function X(t){i.Operator.call(this,null,Y,t)}function Y(t){return this.value&&!t.modified()?this.value:e.key(t.fields,t.flat)}function Z(t){i.Transform.call(this,{},t)}function tt(t){i.Operator.call(this,null,et,t)}function et(t){if(this.value&&!t.modified())return this.value;var e,i,n,a=1/0,r=-1/0,s=t.extents;for(e=0,i=s.length;e<i;++e)(n=s[e])[0]<a&&(a=n[0]),n[1]>r&&(r=n[1]);return[a,r]}function it(t){i.Operator.call(this,null,nt,t)}function nt(t){return this.value&&!t.modified()?this.value:t.values.reduce(function(t,e){return t.concat(e)},[])}function at(t){i.Transform.call(this,null,t)}function rt(t){p.call(this,t)}V.transform=function(t,i){var n,a=this,r=t.modified();return a.value&&(r||i.modified(a._inputs))?(n=a.value=r?a.init(t):{},i.visit(i.SOURCE,function(t){a.add(t)})):(n=a.value=a.value||this.init(t),i.visit(i.REM,function(t){a.rem(t)}),i.visit(i.ADD,function(t){a.add(t)})),a.changes(),i.visit(i.SOURCE,function(t){e.extend(t,n[a.cellkey(t)].tuple)}),i.reflow(r).modifies(this._outputs)},V.changes=function(){var t,e,i=this._adds,n=this._mods;for(t=0,e=this._alen;t<e;++t)this.celltuple(i[t]),i[t]=null;for(t=0,e=this._mlen;t<e;++t)this.celltuple(n[t]),n[t]=null;this._alen=this._mlen=0},e.inherits(X,i.Operator),Z.Definition={type:"Lookup",metadata:{modifies:!0},params:[{name:"index",type:"index",params:[{name:"from",type:"data",required:!0},{name:"key",type:"field",required:!0}]},{name:"values",type:"field",array:!0},{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0},{name:"default",default:null}]},e.inherits(Z,i.Transform).transform=function(t,i){var n,a,r=i,s=t.as,u=t.fields,o=t.index,l=t.values,f=null==t.default?null:t.default,d=t.modified(),m=d?i.SOURCE:i.ADD,h=u.length;return l?(a=l.length,h>1&&!s&&e.error('Multi-field lookup requires explicit "as" parameter.'),s&&s.length!==h*a&&e.error('The "as" parameter has too few output field names.'),s=s||l.map(e.accessorName),n=function(t){for(var e,i,n=0,r=0;n<h;++n)if(null==(i=o.get(u[n](t))))for(e=0;e<a;++e,++r)t[s[r]]=f;else for(e=0;e<a;++e,++r)t[s[r]]=l[e](i)}):(s||e.error("Missing output field names."),n=function(t){for(var e,i=0;i<h;++i)e=o.get(u[i](t)),t[s[i]]=null==e?f:e}),d?r=i.reflow(!0):m|=u.some(function(t){return i.modified(t.fields)})?i.MOD:0,i.visit(m,n),r.modifies(s)},e.inherits(tt,i.Operator),e.inherits(it,i.Operator),e.inherits(at,i.Transform),at.prototype.transform=function(t,e){return this.modified(t.modified()),this.value=t,e.fork(e.NO_SOURCE|e.NO_FIELDS)},rt.Definition={type:"Pivot",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"field",type:"field",required:!0},{name:"value",type:"field",required:!0},{name:"op",type:"enum",values:o,default:"sum"},{name:"limit",type:"number",default:0},{name:"key",type:"field"}]};var st=e.inherits(rt,p);function ut(t){F.call(this,t)}function ot(t){i.Transform.call(this,null,t)}function lt(t){i.Transform.call(this,null,t)}function ft(t){i.Transform.call(this,null,t)}function dt(t){i.Transform.call(this,[],t),this.count=0}function mt(t){i.Transform.call(this,null,t)}function ht(t){i.Transform.call(this,null,t),this.modified(!0)}function ct(t){i.Transform.call(this,e.fastmap(),t)}function pt(t){i.Transform.call(this,null,t)}st._transform=st.transform,st.transform=function(t,i){return this._transform((a=i,r=(n=t).field,s=n.value,u=("count"===n.op?"__count__":n.op)||"sum",o=e.accessorFields(r).concat(e.accessorFields(s)),f=r,d=n.limit||0,h={},c=[],(m=a).visit(m.SOURCE,function(t){var e=f(t);h[e]||(h[e]=1,c.push(e))}),c.sort(function(t,e){return(t<e||null==t)&&null!=e?-1:(t>e||null==e)&&null!=t?1:(e=e instanceof Date?+e:e,(t=t instanceof Date?+t:t)!==t&&e==e?-1:e!=e&&t==t?1:0)}),l=d?c.slice(0,d):c,{key:n.key,groupby:n.groupby,ops:l.map(function(){return u}),fields:l.map(function(t){return i=t,n=r,a=s,u=o,e.accessor(function(t){return n(t)===i?a(t):NaN},u,i+"");var i,n,a,u}),as:l.map(function(t){return t+""}),modified:n.modified.bind(n)}),i);var n,a,r,s,u,o,l,f,d,m,h,c},e.inherits(ut,F).transform=function(t,n){var a=this,r=t.subflow,s=t.field;return(t.modified("field")||s&&n.modified(e.accessorFields(s)))&&e.error("PreFacet does not support field modification."),this._targets.active=0,n.visit(n.MOD,function(t){var e=a.subflow(i.tupleid(t),r,n,t);s?s(t).forEach(function(t){e.mod(t)}):e.mod(t)}),n.visit(n.ADD,function(t){var e=a.subflow(i.tupleid(t),r,n,t);s?s(t).forEach(function(t){e.add(i.ingest(t))}):e.add(t)}),n.visit(n.REM,function(t){var e=a.subflow(i.tupleid(t),r,n,t);s?s(t).forEach(function(t){e.rem(t)}):e.rem(t)}),n},ot.Definition={type:"Project",metadata:{generates:!0,changes:!0},params:[{name:"fields",type:"field",array:!0},{name:"as",type:"string",null:!0,array:!0}]},e.inherits(ot,i.Transform).transform=function(t,e){var n,a,r=t.fields,s=j(t.fields,t.as||[]),u=r?function(t,e){return function(t,e,i,n){for(var a=0,r=i.length;a<r;++a)e[n[a]]=i[a](t);return e}(t,e,r,s)}:i.rederive;return this.value?a=this.value:(e=e.addAll(),a=this.value={}),n=e.fork(e.NO_SOURCE),e.visit(e.REM,function(t){var e=i.tupleid(t);n.rem.push(a[e]),a[e]=null}),e.visit(e.ADD,function(t){var e=u(t,i.ingest({}));a[i.tupleid(t)]=e,n.add.push(e)}),e.visit(e.MOD,function(t){n.mod.push(u(t,a[i.tupleid(t)]))}),n},e.inherits(lt,i.Transform).transform=function(t,e){return this.value=t.value,t.modified("value")?e.fork(e.NO_SOURCE|e.NO_FIELDS):e.StopPropagation},e.inherits(ft,i.Transform).transform=function(t,e){var n,a;return this.value?a=this.value:(n=e=e.addAll(),a=this.value={}),t.derive&&(n=e.fork(e.NO_SOURCE),e.visit(e.REM,function(t){var e=i.tupleid(t);n.rem.push(a[e]),a[e]=null}),e.visit(e.ADD,function(t){var e=i.derive(t);a[i.tupleid(t)]=e,n.add.push(e)}),e.visit(e.MOD,function(t){n.mod.push(i.rederive(t,a[i.tupleid(t)]))})),n},dt.Definition={type:"Sample",metadata:{},params:[{name:"size",type:"number",default:1e3}]},e.inherits(dt,i.Transform).transform=function(t,e){var a=e.fork(e.NO_SOURCE),r=t.modified("size"),s=t.size,u=this.value,o=this.count,l=0,f=u.reduce(function(t,e){return t[i.tupleid(e)]=1,t},{});function d(t){var e,r;u.length<s?u.push(t):(r=~~((o+1)*n.random()))<u.length&&r>=l&&(e=u[r],f[i.tupleid(e)]&&a.rem.push(e),u[r]=t),++o}if(e.rem.length&&(e.visit(e.REM,function(t){var e=i.tupleid(t);f[e]&&(f[e]=-1,a.rem.push(t)),--o}),u=u.filter(function(t){return-1!==f[i.tupleid(t)]})),(e.rem.length||r)&&u.length<s&&e.source&&(l=o=u.length,e.visit(e.SOURCE,function(t){f[i.tupleid(t)]||d(t)}),l=-1),r&&u.length>s){for(var m=0,h=u.length-s;m<h;++m)f[i.tupleid(u[m])]=-1,a.rem.push(u[m]);u=u.slice(h)}return e.mod.length&&e.visit(e.MOD,function(t){f[i.tupleid(t)]&&a.mod.push(t)}),e.add.length&&e.visit(e.ADD,d),(e.add.length||l<0)&&(a.add=u.filter(function(t){return!f[i.tupleid(t)]})),this.count=o,this.value=a.source=u,a},mt.Definition={type:"Sequence",metadata:{changes:!0},params:[{name:"start",type:"number",required:!0},{name:"stop",type:"number",required:!0},{name:"step",type:"number",default:1}],output:["value"]},e.inherits(mt,i.Transform).transform=function(t,e){if(!this.value||t.modified()){var n=e.materialize().fork(e.MOD);return n.rem=this.value?e.rem.concat(this.value):e.rem,this.value=a.range(t.start,t.stop,t.step||1).map(i.ingest),n.add=e.add.concat(this.value),n}},e.inherits(ht,i.Transform).transform=function(t,e){return this.value=e.source,e.changed()?e.fork(e.NO_SOURCE|e.NO_FIELDS):e.StopPropagation},e.inherits(ct,i.Transform).transform=function(t,e){var i=e.dataflow,n=t.field,a=this.value,r=!0;function s(t){a.set(n(t),t)}return t.modified("field")||e.modified(n.fields)?(a.clear(),e.visit(e.SOURCE,s)):e.changed()?(e.visit(e.REM,function(t){a.delete(n(t))}),e.visit(e.ADD,s)):r=!1,this.modified(r),a.empty>i.cleanThreshold&&i.runAfter(a.clean),e.fork()},e.inherits(pt,i.Transform).transform=function(t,e){(!this.value||t.modified("field")||t.modified("sort")||e.changed()||t.sort&&e.modified(t.sort.fields))&&(this.value=(t.sort?e.source.slice().sort(t.sort):e.source).map(t.field))};var vt={row_number:function(){return{next:function(t){return t.index+1}}},rank:function(){var t;return{init:function(){t=1},next:function(e){var i=e.index,n=e.data;return i&&e.compare(n[i-1],n[i])?t=i+1:t}}},dense_rank:function(){var t;return{init:function(){t=1},next:function(e){var i=e.index,n=e.data;return i&&e.compare(n[i-1],n[i])?++t:t}}},percent_rank:function(){var t=vt.rank(),e=t.next;return{init:t.init,next:function(t){return(e(t)-1)/(t.data.length-1)}}},cume_dist:function(){var t;return{init:function(){t=0},next:function(e){var i=e.index,n=e.data,a=e.compare;if(t<i){for(;i+1<n.length&&!a(n[i],n[i+1]);)++i;t=i}return(1+t)/n.length}}},ntile:function(t,i){(i=+i)>0||e.error("ntile num must be greater than zero.");var n=vt.cume_dist(),a=n.next;return{init:n.init,next:function(t){return Math.ceil(i*a(t))}}},lag:function(t,e){return e=+e||1,{next:function(i){var n=i.index-e;return n>=0?t(i.data[n]):null}}},lead:function(t,e){return e=+e||1,{next:function(i){var n=i.index+e,a=i.data;return n<a.length?t(a[n]):null}}},first_value:function(t){return{next:function(e){return t(e.data[e.i0])}}},last_value:function(t){return{next:function(e){return t(e.data[e.i1-1])}}},nth_value:function(t,i){return(i=+i)>0||e.error("nth_value nth must be greater than zero."),{next:function(e){var n=e.i0+(i-1);return n<e.i1?t(e.data[n]):null}}}},gt=Object.keys(vt);function yt(t){var i=e.array(t.ops),n=e.array(t.fields),a=e.array(t.params),r=e.array(t.as),u=this.outputs=[],o=this.windows=[],f={},d={},c=!0,p=[],v=[];function g(t){e.array(e.accessorFields(t)).forEach(function(t){f[t]=1})}g(t.sort),i.forEach(function(t,i){var f,m,h,y,_,x=n[i],O=e.accessorName(x),D=s(t,O,r[i]);if(g(x),u.push(D),vt.hasOwnProperty(t))o.push((f=t,m=n[i],h=a[i],y=D,{init:(_=vt[f](m,h)).init||e.zero,update:function(t,e){e[y]=_.next(t)}}));else{if(null==x&&"count"!==t&&e.error("Null aggregate field specified."),"count"===t)return void p.push(D);c=!1;var b=d[O];b||((b=d[O]=[]).field=x,v.push(b)),b.push(l(t,D))}}),(p.length||v.length)&&(this.cell=function(t,e,i){t=t.map(function(t){return m(t,t.field)});var n={num:0,agg:null,store:!1,count:e};if(!i)for(var a=t.length,r=n.agg=Array(a),s=0;s<a;++s)r[s]=new t[s](n);if(n.store)var u=n.data=new h;return n.add=function(t){if(n.num+=1,!i){u&&u.add(t);for(var e=0;e<a;++e)r[e].add(r[e].get(t),t)}},n.rem=function(t){if(n.num-=1,!i){u&&u.rem(t);for(var e=0;e<a;++e)r[e].rem(r[e].get(t),t)}},n.set=function(t){var a,s;for(u&&u.values(),a=0,s=e.length;a<s;++a)t[e[a]]=n.num;if(!i)for(a=0,s=r.length;a<s;++a)r[a].set(t)},n.init=function(){n.num=0,u&&u.reset();for(var t=0;t<a;++t)r[t].init()},n}(v,p,c)),this.inputs=Object.keys(f)}var _t=yt.prototype;function xt(t){i.Transform.call(this,{},t),this._mlen=0,this._mods=[]}_t.init=function(){this.windows.forEach(function(t){t.init()}),this.cell&&this.cell.init()},_t.update=function(t,e){var i,n=this.cell,a=this.windows,r=t.data,s=a&&a.length;if(n){for(i=t.p0;i<t.i0;++i)n.rem(r[i]);for(i=t.p1;i<t.i1;++i)n.add(r[i]);n.set(e)}for(i=0;i<s;++i)a[i].update(t,e)},xt.Definition={type:"Window",metadata:{modifies:!0},params:[{name:"sort",type:"compare"},{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:gt.concat(o)},{name:"params",type:"number",null:!0,array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"as",type:"string",null:!0,array:!0},{name:"frame",type:"number",null:!0,array:!0,length:2,default:[null,0]},{name:"ignorePeers",type:"boolean",default:!1}]};var Ot=e.inherits(xt,i.Transform);function Dt(t,i,n){var r=n.sort,s=r&&!n.ignorePeers,u=n.frame||[null,0],o=t.data(r),l=o.length,f=0,d=s?a.bisector(r):null,m={i0:0,i1:0,p0:0,p1:0,index:0,data:o,compare:r||e.constant(-1)};for(i.init();f<l;++f)bt(m,u,f,l),s&&Et(m,d),i.update(m,o[f])}function bt(t,e,i,n){t.p0=t.i0,t.p1=t.i1,t.i0=null==e[0]?0:Math.max(0,i-Math.abs(e[0])),t.i1=null==e[1]?n:Math.min(n,i+Math.abs(e[1])+1),t.index=i}function Et(t,e){var i=t.i0,n=t.i1-1,a=t.compare,r=t.data,s=r.length-1;i>0&&!a(r[i],r[i-1])&&(t.i0=e.left(r,r[i])),n<s&&!a(r[n],r[n+1])&&(t.i1=e.right(r,r[n]))}Ot.transform=function(t,e){var i,n,a=this,s=a.state,u=t.modified();this.stamp=e.stamp,s&&!u||(s=a.state=new yt(t));var o=r(t.groupby);function l(t){return a.group(o(t))}for(u||e.modified(s.inputs)?(a.value={},e.visit(e.SOURCE,function(t){l(t).add(t)})):(e.visit(e.REM,function(t){l(t).remove(t)}),e.visit(e.ADD,function(t){l(t).add(t)})),i=0,n=a._mlen;i<n;++i)Dt(a._mods[i],s,t);return a._mlen=0,a._mods=[],e.reflow(u).modifies(s.outputs)},Ot.group=function(t){var e=this,n=e.value[t];return n||((n=e.value[t]=_(i.tupleid)).stamp=-1),n.stamp<e.stamp&&(n.stamp=e.stamp,e._mods[e._mlen++]=n),n},t.aggregate=p,t.bin=g,t.collect=x,t.compare=O,t.countpattern=b,t.cross=k,t.density=R,t.extent=C,t.facet=F,t.field=L,t.filter=I,t.flatten=W,t.fold=B,t.formula=J,t.generate=K,t.impute=H,t.joinaggregate=Q,t.key=X,t.lookup=Z,t.multiextent=tt,t.multivalues=it,t.params=at,t.pivot=rt,t.prefacet=ut,t.project=ot,t.proxy=lt,t.relay=ft,t.sample=dt,t.sequence=mt,t.sieve=ht,t.subflow=A,t.tupleindex=ct,t.values=pt,t.window=xt,Object.defineProperty(t,"__esModule",{value:!0})});