!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vega-dataflow"),require("vega-util")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-util"],e):e(t.vega=t.vega||{},t.vega,t.vega)}(this,function(t,e,n){"use strict";function r(t,e,n){";"!==e[e.length-1]&&(e="return("+e+");");var r=Function.apply(null,t.concat(e));return n&&n.functions?r.bind(n.functions):r}function a(t,e){return r(["_"],t,e)}function o(t,e){return r(["datum","_"],t,e)}function s(t,e){return r(["event"],t,e)}function i(t,e){return r(["_","event"],t,e)}function u(t,e){return r(["item","_"],t,e)}function c(t,e,r){r=r||{};var a,o;for(a in t)(o=t[a])&&o.$expr&&o.$params&&c(o.$params,e,r),r[a]=n.isArray(o)?o.map(function(t){return f(t,e)}):f(o,e);return r}function f(t,e){if(!t||!n.isObject(t))return t;for(var r,a=0,o=$.length;a<o;++a)if(r=$[a],t.hasOwnProperty(r.key))return r.parse(t,e);return t}function d(t){return(t+"").toLowerCase()}function l(t){return"operator"===d(t)}function p(t){return"collect"===d(t)}function h(t,e){var r,a;t.params&&((r=e.get(t.id))||n.error("Invalid operator id: "+t.id),a=c(t.params,e),e.dataflow.connect(r,r.parameters(a)))}function v(t,e,n){this.dataflow=t,this.transforms=e,this.events=t.events.bind(t),this.signals={},this.scales={},this.nodes={},this.data={},this.fn={},n&&(this.functions=Object.create(n),this.functions.context=this)}function g(t){this.dataflow=t.dataflow,this.transforms=t.transforms,this.functions=t.functions,this.events=t.events,this.signals=Object.create(t.signals),this.scales=Object.create(t.scales),this.nodes=Object.create(t.nodes),this.data=Object.create(t.data),this.fn=Object.create(t.fn),t.functions&&(this.functions=Object.create(t.functions),this.functions.context=this)}var $=[{key:"$ref",parse:function(t,e){return e.get(t.$ref)||n.error("Operator not defined: "+t.$ref)}},{key:"$key",parse:function(t,e){var r="k:"+t.$key+"_"+!!t.$flat;return e.fn[r]||(e.fn[r]=n.key(t.$key,t.$flat))}},{key:"$expr",parse:function(t,e){var r="e:"+t.$expr;return e.fn[r]||(e.fn[r]=n.accessor(o(t.$expr,e),t.$fields,t.$name))}},{key:"$field",parse:function(t,e){if(!t.$field)return null;var r="f:"+t.$field+"_"+t.$name;return e.fn[r]||(e.fn[r]=n.field(t.$field,t.$name))}},{key:"$encode",parse:function(t,e){var r,a,o=t.$encode,s={};for(r in o)a=o[r],s[r]=n.accessor(u(a.$expr,e),a.$fields),s[r].output=a.$output;return s}},{key:"$compare",parse:function(t,r){var a="c:"+t.$compare+"_"+t.$order,o=n.array(t.$compare).map(function(t){return t&&t.$tupleid?e.tupleid:t});return r.fn[a]||(r.fn[a]=n.compare(o,t.$order))}},{key:"$context",parse:function(t,e){return e}},{key:"$subflow",parse:function(t,e){var n=t.$subflow;return function(t,r,a){var o=k(n,e.fork()),s=o.get(n.operators[0].id),i=o.signals.parent;return i&&i.set(a),s}}},{key:"$tupleid",parse:function(){return e.tupleid}}],m=function(t,e){l(t.type)||!t.type?e.operator(t,t.update?a(t.update,e):null):e.transform(t,t.type)},b=function(t,e){var r,a=null!=t.filter?s(t.filter,e):void 0,o=null!=t.stream?e.get(t.stream):void 0;t.source?o=e.events(t.source,t.type,a):t.merge&&(o=(r=t.merge.map(e.get.bind(e)))[0].merge.apply(r[0],r.slice(1))),t.between&&(r=t.between.map(e.get.bind(e)),o=o.between(r[0],r[1])),t.filter&&(o=o.filter(a)),null!=t.throttle&&(o=o.throttle(+t.throttle)),null!=t.debounce&&(o=o.debounce(+t.debounce)),null==o&&n.error("Invalid stream definition: "+JSON.stringify(t)),t.consume&&o.consume(!0),e.stream(t,o)},y=function(t,e){var r=e.get(t.source),a=null,o=t.update,u=void 0;r||n.error("Source not defined: "+t.source),a=t.target&&t.target.$expr?s(t.target.$expr,e):e.get(t.target),o&&o.$expr&&(o.$params&&(u=c(o.$params,e)),o=i(o.$expr,e)),e.update(t,r,a,o,u)},k=function(t,e){var n=t.operators||[];return t.background&&(e.background=t.background),t.eventConfig&&(e.eventConfig=t.eventConfig),n.forEach(function(t){m(t,e)}),n.forEach(function(t){h(t,e)}),(t.streams||[]).forEach(function(t){b(t,e)}),(t.updates||[]).forEach(function(t){y(t,e)}),e.resolve()},x={skip:!0};v.prototype=g.prototype={fork:function(){var t=new g(this);return(this.subcontext||(this.subcontext=[])).push(t),t},get:function(t){return this.nodes[t]},set:function(t,e){return this.nodes[t]=e},add:function(t,e){var n,r=this,a=r.dataflow;if(r.set(t.id,e),p(t.type)&&(n=t.value)&&(n.$ingest?a.ingest(e,n.$ingest,n.$format):n.$request?a.request(e,n.$request,n.$format):a.pulse(e,a.changeset().insert(n))),t.root&&(r.root=e),t.parent){var o=r.get(t.parent.$ref);o?(a.connect(o,[e]),e.targets().add(o)):(r.unresolved=r.unresolved||[]).push(function(){o=r.get(t.parent.$ref),a.connect(o,[e]),e.targets().add(o)})}if(t.signal&&(r.signals[t.signal]=e),t.scale&&(r.scales[t.scale]=e),t.data)for(var s in t.data)n=r.data[s]||(r.data[s]={}),t.data[s].forEach(function(t){n[t]=e})},resolve:function(){return(this.unresolved||[]).forEach(function(t){t()}),delete this.unresolved,this},operator:function(t,e,n){this.add(t,this.dataflow.add(t.value,e,n,t.react))},transform:function(t,e,n){this.add(t,this.dataflow.add(this.transforms[d(e)],n))},stream:function(t,e){this.set(t.id,e)},update:function(t,e,n,r,a){this.dataflow.on(e,n,r,a,t.options)},getState:function(t){var e=this,n={};if(t.signals){var r=n.signals={};Object.keys(e.signals).forEach(function(n){var a=e.signals[n];t.signals(n,a)&&(r[n]=a.value)})}if(t.data){var a=n.data={};Object.keys(e.data).forEach(function(n){var r=e.data[n];t.data(n,r)&&(a[n]=r.input.value)})}return e.subcontext&&!1!==t.recurse&&(n.subcontext=e.subcontext.map(function(e){return e.getState(t)})),n},setState:function(t){var e=this,r=e.dataflow,a=t.data,o=t.signals;Object.keys(o||{}).forEach(function(t){r.update(e.signals[t],o[t],x)}),Object.keys(a||{}).forEach(function(t){r.pulse(e.data[t].input,r.changeset().remove(n.truthy).insert(a[t]))}),(t.subcontext||[]).forEach(function(t,n){var r=e.subcontext[n];r&&r.setState(t)})}},t.parse=k,t.context=function(t,e,n){return new v(t,e,n)},t.expression=r,Object.defineProperty(t,"__esModule",{value:!0})});