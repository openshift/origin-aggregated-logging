!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vega-dataflow"),require("vega-scenegraph"),require("vega-util")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-scenegraph","vega-util"],e):e((t.vega=t.vega||{},t.vega.transforms=t.vega.transforms||{}),t.vega,t.vega,t.vega)}(this,function(t,e,n,r){"use strict";function o(t){e.Transform.call(this,null,t)}function a(t,e,n){return e(t.bounds.clear(),t,n)}function i(t){e.Transform.call(this,0,t)}function u(t){e.Transform.call(this,null,t)}function s(t){e.Transform.call(this,null,t)}function d(t,e){return!(t.x2-1<e.x1||t.x1+1>e.x2||t.y2-1<e.y1||t.y1+1>e.y2)}function l(t){for(var e,n=1,r=t.length,o=t[0].bounds;n<r;o=e,++n)if(d(o,e=t[n].bounds))return!0}function c(t){var e=t.bounds;return e.width()>1&&e.height()>1}function f(t){e.Transform.call(this,null,t)}function h(t,e){for(var n=0,r=t.length;n<r;++n)e.push(t[n])}function m(t,e,n){var o=r.isObject(t)?t[e]:t;return null!=o?o:void 0!==n?n:0}function b(t){return t<0?Math.ceil(-t):0}function y(t,e,r){function o(t,e){return Math.floor(Math.min(t,e))}function a(t,e){return Math.ceil(Math.max(t,e))}var i,u,s,d,l,c,f,y,p,v,k,w,M,T=function(t){for(var e,n,r=t.items,o=r.length,a=0,i={marks:[],rowheaders:[],rowfooters:[],colheaders:[],colfooters:[],rowtitle:null,coltitle:null};a<o;++a)if(e=r[a],n=e.items,"group"===e.marktype)switch(e.role){case O:case j:break;case S:h(n,i.rowheaders);break;case q:h(n,i.rowfooters);break;case I:h(n,i.colheaders);break;case C:h(n,i.colfooters);break;case A:i.rowtitle=n[0];break;case F:i.coltitle=n[0];break;default:h(n,i.marks)}return i}(e),z=T.marks,E="flush"===r.bounds,B=E?function(t){return{x1:0,y1:0,x2:t.width||0,y2:t.height||0}}:function(t){var e=t.bounds.clone();return e.empty()?e.set(0,0,0,0):e.translate(-(t.x||0),-(t.y||0))},D=new n.Bounds(0,0,0,0),_=m(r.align,"column"),G=m(r.align,"row"),H=m(r.padding,"column"),L=m(r.padding,"row"),P=r.offset,R=e.columns||r.columns||z.length,U=R<0?1:Math.ceil(z.length/R),V=U*R,W=[],J=[],K=[],N=[],Q=z.length;for(u=0;u<R;++u)J[u]=0;for(u=0;u<U;++u)N[u]=0;for(u=0;u<Q;++u)l=B(z[u]),d=~~(u/R),f=(s=u%R)?Math.ceil(B(z[u-1]).x2):0,y=d?Math.ceil(B(z[u-R]).y2):0,J[s]=Math.max(J[s],f),N[d]=Math.max(N[d],y),W.push(H+b(l.x1)),K.push(L+b(l.y1)),t.dirty(z[u]);for(u=0;u<Q;++u)u%R==0&&(W[u]=0),u<R&&(K[u]=0);if("each"===_)for(s=1;s<R;++s){for(M=0,u=s;u<Q;u+=R)M<W[u]&&(M=W[u]);for(u=s;u<Q;u+=R)W[u]=M+J[s]}else if("all"===_){for(w=0,s=1;s<R;++s)w<J[s]&&(w=J[s]);for(M=0,u=0;u<Q;++u)u%R&&M<W[u]&&(M=W[u]);for(u=0;u<Q;++u)u%R&&(W[u]=M+w)}else for(s=1;s<R;++s)for(u=s;u<Q;u+=R)W[u]+=J[s];if("each"===G)for(d=1;d<U;++d){for(M=0,i=(u=d*R)+R;u<i;++u)M<K[u]&&(M=K[u]);for(u=d*R;u<i;++u)K[u]=M+N[d]}else if("all"===G){for(w=0,d=1;d<U;++d)w<N[d]&&(w=N[d]);for(M=0,u=R;u<Q;++u)M<K[u]&&(M=K[u]);for(u=R;u<Q;++u)K[u]=M+w}else for(d=1;d<U;++d)for(i=(u=d*R)+R;u<i;++u)K[u]+=N[d];for(p=0,u=0;u<Q;++u)f=(c=z[u]).x||0,c.x=p=W[u]+(u%R?p:0),c.bounds.translate(p-f,0);for(s=0;s<R;++s)for(v=0,u=s;u<Q;u+=R)y=(c=z[u]).y||0,c.y=v+=K[u],c.bounds.translate(0,v-y);for(u=0;u<Q;++u)z[u].mark.bounds.clear();for(u=0;u<Q;++u)c=z[u],t.dirty(c),D.union(c.mark.bounds.union(c.bounds));B=E?function(t,e){return"x1"===e?t.x||0:"y1"===e?t.y||0:"x2"===e?(t.x||0)+(t.width||0):"y2"===e?(t.y||0)+(t.height||0):void 0}:function(t,e){return t.bounds[e]},k=m(r.headerBand,"row",null),p=g(t,T.rowheaders,z,R,U,-m(P,"rowHeader"),o,0,B,"x1",0,R,1,k),k=m(r.headerBand,"column",null),v=g(t,T.colheaders,z,R,R,-m(P,"columnHeader"),o,1,B,"y1",0,1,R,k),k=m(r.footerBand,"row",null),g(t,T.rowfooters,z,R,U,m(P,"rowFooter"),a,0,B,"x2",R-1,R,1,k),k=m(r.footerBand,"column",null),g(t,T.colfooters,z,R,R,m(P,"columnFooter"),a,1,B,"y2",V-R,1,R,k),T.rowtitle&&(M=p-m(P,"rowTitle"),k=m(r.titleBand,"row",.5),x(t,T.rowtitle,M,0,D,k)),T.coltitle&&(M=v-m(P,"columnTitle"),k=m(r.titleBand,"column",.5),x(t,T.coltitle,M,1,D,k))}function g(t,e,n,r,o,a,i,u,s,d,l,c,f,h){var m,b,y,g,x,p,v,k,w,M=n.length,T=0,z=0;if(!M)return T;for(m=l;m<M;m+=c)n[m]&&(T=i(T,s(n[m],d)));if(!e.length)return T;for(e.length>o&&(t.warn("Grid headers exceed limit: "+o),e=e.slice(0,o)),T+=a,b=0,g=e.length;b<g;++b)t.dirty(e[b]),e[b].mark.bounds.clear();for(m=l,b=0,g=e.length;b<g;++b,m+=c){for(x=(p=e[b]).mark.bounds,y=m;y>=0&&null==(v=n[y]);y-=f);u?(k=null==h?v.x:Math.round(v.bounds.x1+h*v.bounds.width()),w=T):(k=T,w=null==h?v.y:Math.round(v.bounds.y1+h*v.bounds.height())),x.union(p.bounds.translate(k-(p.x||0),w-(p.y||0))),p.x=k,p.y=w,t.dirty(p),z=i(z,x[d])}return z}function x(t,e,n,r,o,a){if(e){t.dirty(e);var i=n,u=n;r?i=Math.round(o.x1+a*o.width()):u=Math.round(o.y1+a*o.height()),e.bounds.translate(i-(e.x||0),u-(e.y||0)),e.mark.bounds.clear().union(e.bounds),e.x=i,e.y=u,t.dirty(e)}}function p(t){e.Transform.call(this,null,t)}function v(t,e,r){var o,a,i,u,s,d,l=e.items,c=Math.max(0,e.width||0),f=Math.max(0,e.height||0),h=(new n.Bounds).set(0,0,c,f),m=h.clone(),b=h.clone(),y=h.clone(),g=[];for(s=0,d=l.length;s<d;++s)switch((a=l[s]).role){case V:m.union(u=function(t,e,r,o){var a,i,u=e.items[0],s=u.datum,d=s.orient,l=function(t){var e=+t.grid;return[t.ticks?e++:-1,t.labels?e++:-1,e+ +t.domain]}(s),c=u.range,f=u.offset,h=u.position,m=u.minExtent,b=u.maxExtent,y=s.title&&u.items[l[2]].items[0],g=u.titlePadding,x=u.bounds,p=0,v=0;tt.clear().union(x),x.clear(),(a=l[0])>-1&&x.union(u.items[a].bounds);(a=l[1])>-1&&x.union(u.items[a].bounds);switch(d){case z:p=h||0,v=-f,i=Math.max(m,Math.min(b,-x.y1)),y&&(i=M(y,i,g,0,-1,x)),x.add(0,-i).add(c,0);break;case E:p=-f,v=h||0,i=Math.max(m,Math.min(b,-x.x1)),y&&(i=M(y,i,g,1,-1,x)),x.add(-i,0).add(0,c);break;case B:p=r+f,v=h||0,i=Math.max(m,Math.min(b,x.x2)),y&&(i=M(y,i,g,1,1,x)),x.add(0,0).add(i,c);break;case D:p=h||0,v=o+f,i=Math.max(m,Math.min(b,x.y2)),y&&(i=M(y,i,g,0,1,x)),x.add(0,0).add(c,i);break;default:p=u.x,v=u.y}n.boundStroke(x.translate(p,v),u),k(u,"x",p+$)|k(u,"y",v+$)&&(u.bounds=tt,t.dirty(u),u.bounds=x,t.dirty(u));return u.mark.bounds.clear().union(x)}(t,a,c,f)),(w(a)?b:y).union(u);break;case W:o=a;break;case K:g.push(a);break;case J:case N:case Q:case X:case Y:case Z:b.union(a.bounds),y.union(a.bounds);break;default:h.union(a.bounds)}if(o&&(m.union(u=function(t,e,n){var r=e.items[0],o=r.datum.orient,a=r.offset,i=r.bounds,u=0,s=0;switch(tt.clear().union(i),o){case z:u=r.x,s=n.y1-a;break;case E:u=n.x1-a,s=r.y;break;case B:u=n.x2+a,s=r.y;break;case D:u=r.x,s=n.y2+a;break;default:u=r.x,s=r.y}i.translate(u-r.x,s-r.y),k(r,"x",u)|k(r,"y",s)&&(r.bounds=tt,t.dirty(r),r.bounds=i,t.dirty(r));return e.bounds.clear().union(i)}(t,o,m)),(w(o)?b:y).union(u)),g.length)for(i={left:0,right:0,top:0,bottom:0,margin:r.legendMargin||8},s=0,d=g.length;s<d;++s)if(u=function(t,e,r,o,a,i,u){var s,d,l,c=e.items[0],f=c.datum.orient,h=c.offset,m=c.bounds,b=0,y=0;f===z||f===D?(l=a,b=r[f]):f!==E&&f!==B||(l=o,y=r[f]);switch(tt.clear().union(m),m.clear(),c.items.forEach(function(t){m.union(t.bounds)}),s=Math.round(m.width())+2*c.padding-1,d=Math.round(m.height())+2*c.padding-1,f){case E:b-=s+h-Math.floor(l.x1),r.left+=d+r.margin;break;case B:b+=h+Math.ceil(l.x2),r.right+=d+r.margin;break;case z:y-=d+h-Math.floor(l.y1),r.top+=s+r.margin;break;case D:y+=h+Math.ceil(l.y2),r.bottom+=s+r.margin;break;case"top-left":b+=h,y+=h;break;case"top-right":b+=i-s-h,y+=h;break;case"bottom-left":b+=h,y+=u-d-h;break;case"bottom-right":b+=i-s-h,y+=u-d-h;break;default:b=c.x,y=c.y}n.boundStroke(m.set(b,y,b+s,y+d),c),k(c,"x",b)|k(c,"width",s)|k(c,"y",y)|k(c,"height",d)&&(c.bounds=tt,t.dirty(c),c.bounds=m,t.dirty(c));return c.mark.bounds.clear().union(m)}(t,g[s],i,b,y,c,f),r.autosize&&r.autosize.type===G){var x=g[s].items[0].datum.orient;x===E||x===B?h.add(u.x1,0).add(u.x2,0):x!==z&&x!==D||h.add(0,u.y1).add(0,u.y2)}else h.union(u);h.union(b).union(y).union(m),function(t,e,n,r){var o=r.autosize||{},a=o.type,i=t._width,u=t._height,s=t.padding();if(t._autosize<1||!a)return;var d=Math.max(0,e.width||0),l=Math.max(0,Math.ceil(-n.x1)),c=Math.max(0,Math.ceil(n.x2-d)),f=Math.max(0,e.height||0),h=Math.max(0,Math.ceil(-n.y1)),m=Math.max(0,Math.ceil(n.y2-f));o.contains===U&&(i-=s.left+s.right,u-=s.top+s.bottom);a===R?(l=0,h=0,d=i,f=u):a===G?(d=Math.max(0,i-l-c),f=Math.max(0,u-h-m)):a===H?(d=Math.max(0,i-l-c),u=f+h+m):a===L?(i=d+l+c,f=Math.max(0,u-h-m)):a===P&&(i=d+l+c,u=f+h+m);t._resizeView(i,u,d,f,[l,h],o.resize)}(t,e,h,r)}function k(t,e,n){return t[e]===n?0:(t[e]=n,1)}function w(t){var e=t.items[0].datum.orient;return e===E||e===B}function M(t,e,n,r,o,a){var i=t.bounds,u=0,s=0;return t.auto?(e+=n,r?u=(t.x||0)-(t.x=o*e):s=(t.y||0)-(t.y=o*e),i.translate(-u,-s),t.mark.bounds.set(i.x1,i.y1,i.x2,i.y2),r?(a.add(0,i.y1).add(0,i.y2),e+=i.width()):(a.add(i.x1,0).add(i.x2,0),e+=i.height())):a.union(i),e}r.inherits(o,e.Transform).transform=function(t,e){var r,o=e.dataflow,i=t.mark,u=i.marktype,s=n.Marks[u],d=s.bound,l=i.bounds;return s.nested?(i.items.length&&o.dirty(i.items[0]),l=a(i,d),i.items.forEach(function(t){t.bounds.clear().union(l)})):"group"===u||t.modified()?(e.visit(e.MOD,function(t){o.dirty(t)}),l.clear(),i.items.forEach(function(t){l.union(a(t,d))})):(r=e.changed(e.REM),e.visit(e.ADD,function(t){l.union(a(t,d))}),e.visit(e.MOD,function(t){r=r||l.alignsWith(t.bounds),o.dirty(t),l.union(a(t,d))}),r&&(l.clear(),i.items.forEach(function(t){l.union(t.bounds)}))),n.boundClip(i),e.modifies("bounds")};var T=":vega_identifier:";i.Definition={type:"Identifier",metadata:{modifies:!0},params:[{name:"as",type:"string",required:!0}]};r.inherits(i,e.Transform).transform=function(t,e){var n=function(t){var e=t._signals[T];return e||(t._signals[T]=e=t.add(0)),e}(e.dataflow),r=n.value,o=t.as;return e.visit(e.ADD,function(t){t[o]||(t[o]=++r)}),n.set(this.value=r),e};r.inherits(u,e.Transform).transform=function(t,e){var r=this.value;r||((r=e.dataflow.scenegraph().mark(t.markdef,function(t){var e=t.groups,n=t.parent;return e&&1===e.size?e.get(Object.keys(e.object)[0]):e&&n?e.lookup(n):null}(t),t.index)).group.context=t.context,t.context.group||(t.context.group=r.group),r.source=this,r.clip=t.clip,r.interactive=t.interactive,this.value=r);var o="group"===r.marktype?n.GroupItem:n.Item;return e.visit(e.ADD,function(t){o.call(t,r)}),(t.modified("clip")||t.modified("interactive"))&&(r.clip=t.clip,r.interactive=!!t.interactive,r.zdirty=!0,e.reflow()),r.items=e.source,e};var z="top",E="left",B="right",D="bottom",_={parity:function(t){return t.filter(function(t,e){return e%2?t.opacity=0:1})},greedy:function(t){var e;return t.filter(function(t,n){return n&&d(e.bounds,t.bounds)?t.opacity=0:(e=t,1)})}};r.inherits(s,e.Transform).transform=function(t,e){var o=_[t.method]||_.parity,a=e.materialize(e.SOURCE).source;if(a){t.sort&&(a=a.slice().sort(t.sort)),"greedy"===t.method&&(a=a.filter(c)),a.forEach(function(t){t.opacity=1});var i=a;if(i.length>=3&&l(i)){e=e.reflow(t.modified()).modifies("opacity");do{i=o(i)}while(i.length>=3&&l(i));i.length<3&&!r.peek(a).opacity&&(i.length>1&&(r.peek(i).opacity=0),r.peek(a).opacity=1)}if(t.boundScale){var u=function(t,e,r){var o=t.range(),a=new n.Bounds;return e===z||e===D?a.set(o[0],-1/0,o[1],1/0):a.set(-1/0,o[0],1/0,o[1]),a.expand(r||1),function(t){return a.encloses(t.bounds)}}(t.boundScale,t.boundOrient,t.boundTolerance);a.forEach(function(t){u(t)||(t.opacity=0)})}return e}};r.inherits(f,e.Transform).transform=function(t,e){var n=e.dataflow;if(e.visit(e.ALL,function(t){n.dirty(t)}),e.fields&&e.fields.zindex){var r=e.source&&e.source[0];r&&(r.mark.zdirty=!0)}};var O="axis",j="legend",S="row-header",q="row-footer",A="row-title",I="column-header",C="column-footer",F="column-title",G="fit",H="fit-x",L="fit-y",P="pad",R="none",U="padding",V="axis",W="title",J="frame",K="legend",N="scope",Q="row-header",X="row-footer",Y="column-header",Z="column-footer",$=.5,tt=new n.Bounds;r.inherits(p,e.Transform).transform=function(t,e){var n=e.dataflow;return t.mark.items.forEach(function(e){t.layout&&y(n,e,t.layout),v(n,e,t)}),e},t.bound=o,t.identifier=i,t.mark=u,t.overlap=s,t.render=f,t.viewlayout=p,Object.defineProperty(t,"__esModule",{value:!0})});