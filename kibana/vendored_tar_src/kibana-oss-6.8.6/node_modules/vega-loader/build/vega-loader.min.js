!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-util"),require("d3-request"),require("d3-dsv"),require("topojson-client"),require("d3-time-format")):"function"==typeof define&&define.amd?define(["exports","vega-util","d3-request","d3-dsv","topojson-client","d3-time-format"],t):t(e.vega=e.vega||{},e.vega,e.d3,e.d3,e.topojson,e.d3)}(this,function(e,t,r,n,o,i){"use strict";var u=/^([A-Za-z]+:)?\/\//,a="file://",f=["mimeType","responseType","user","password"];function s(e,r){return t.extend({},e.options,r)}function l(e,t){var r=this;return r.sanitize(e,t).then(function(e){var n=e.href;return e.localFile?r.file(n):r.http(n,t)})}function c(e,r){return r=s(this,r),new Promise(function(n,o){var i,f,s,l,c={href:null};null!=e&&"string"==typeof e?(f=u.test(e),(l=r.baseURL)&&!f&&(m(e,"/")||"/"===l[l.length-1]||(e="/"+e),e=l+e),s=(i=m(e,a))||"file"===r.mode||"http"!==r.mode&&!f&&h(),i?e=e.slice(a.length):m(e,"//")&&("file"===r.defaultProtocol?(e=e.slice(2),s=!0):e=(r.defaultProtocol||"http")+":"+e),Object.defineProperty(c,"localFile",{value:!!s}),c.href=e,r.target&&(c.target=r.target+""),n(c)):o("Sanitize failure, invalid URI: "+t.stringValue(e))})}function d(e,t){return t=s(this,t),new Promise(function(n,o){var i,u=r.request(e);for(i in t.headers)u.header(i,t.headers[i]);f.forEach(function(e){t[e]&&u[e](t[e])}),u.on("error",function(t){o(t||"Error loading URL: "+e)}).on("load",function(e){var t=e&&e.responseText;e&&0!==e.status?n(t):o(t||"Error")}).get()})}function p(e){return new Promise(function(t,r){var n=h();n?n.readFile(e,function(e,n){e?r(e):t(n)}):r("No file system access for "+e)})}function h(){var e="function"==typeof require&&require("fs");return e&&t.isFunction(e.readFile)?e:null}function m(e,t){return null!=e&&0===e.lastIndexOf(t,0)}var g={boolean:t.toBoolean,integer:t.toNumber,number:t.toNumber,date:t.toDate,string:t.toString,unknown:t.identity},v=[function(e){return"true"===e||"false"===e||!0===e||!1===e},function(e){return j(e)&&(e=+e)==~~e},j,function(e){return!isNaN(Date.parse(e))}],y=["boolean","integer","number","date"];function O(e,t){if(!e||!e.length)return"unknown";var r,n,o,i,u,a=v.slice();for(n=0,o=e.length;n<o;++n){for(r=t?e[n][t]:e[n],i=0;i<a.length;++i)null==(u=r)||u!=u||a[i](r)||(a.splice(i,1),--i);if(0===a.length)return"string"}return y[v.indexOf(a[0])]}function b(e,t){return t.reduce(function(t,r){return t[r]=O(e,r),t},{})}function j(e){return!(isNaN(+e)||e instanceof Date)}function N(e){return function(r,n){var o={delimiter:e};return P(r,n?t.extend(n,o):o)}}function P(e,r){return r.header&&(e=r.header.map(t.stringValue).join(r.delimiter)+"\n"+e),n.dsvFormat(r.delimiter).parse(e+"")}var q=function(e,r){var n,o,i,u=r&&r.property?t.field(r.property):t.identity;return!t.isObject(e)||(i=e,"function"==typeof Buffer&&t.isFunction(Buffer.isBuffer)&&Buffer.isBuffer(i))?u(JSON.parse(e)):(n=u(e),o&&o.copy?JSON.parse(JSON.stringify(n)):n)};var w={dsv:P,csv:N(","),tsv:N("\t"),json:q,topojson:function(e,r){var n,i,u;return e=q(e,r),n=r&&(u=r.feature)?o.feature:r&&(u=r.mesh)?o.mesh:t.error("Missing TopoJSON feature or mesh parameter."),(i=(i=e.objects[u])?n(e,i):t.error("Invalid TopoJSON object: "+u))&&i.features||[i]}},x=function(e,t){return arguments.length>1?(w[e]=t,this):w.hasOwnProperty(e)?w[e]:null};e.loader=function(e){return{options:e||{},sanitize:c,load:l,file:p,http:d}},e.read=function(e,r,n){var o=x((r=r||{}).type||"json");return o||t.error("Unknown data format type: "+r.type),e=o(e,r),r.parse&&function(e,t,r){if(e.length){r=r||i.timeParse;var n,o,u,a,f,s,l,c=e.columns||Object.keys(e[0]);for("auto"===t&&(t=b(e,c)),c=Object.keys(t),n=c.map(function(e){var n,o,u=t[e];if(u&&(0===u.indexOf("date:")||0===u.indexOf("utc:")))return("'"===(o=(n=u.split(/:(.+)?/,2))[1])[0]&&"'"===o[o.length-1]||'"'===o[0]&&'"'===o[o.length-1])&&(o=o.slice(1,-1)),"utc"===n[0]?i.utcParse(o):r(o);if(!g[u])throw Error("Illegal format pattern: "+e+":"+u);return g[u]}),a=0,s=e.length,l=c.length;a<s;++a)for(o=e[a],f=0;f<l;++f)u=c[f],o[u]=n[f](o[u])}}(e,r.parse,n),e.hasOwnProperty("columns")&&delete e.columns,e},e.inferType=O,e.inferTypes=b,e.typeParsers=g,e.formats=x,Object.defineProperty(e,"__esModule",{value:!0})});