!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("d3-array"),require("vega-dataflow"),require("vega-util")):"function"==typeof define&&define.amd?define(["exports","d3-array","vega-dataflow","vega-util"],r):r((e.vega=e.vega||{},e.vega.transforms=e.vega.transforms||{}),e.d3,e.vega,e.vega)}(this,function(e,r,n,i){"use strict";function t(e){return new Uint8Array(e)}function a(e){return new Uint16Array(e)}function o(e){return new Uint32Array(e)}function f(){var e=8,r=[],n=o(0),i=s(0,e),t=s(0,e);return{data:function(){return r},seen:function(){return n=u(n,r.length)},add:function(e){for(var n,i=0,t=r.length,a=e.length;i<a;++i)(n=e[i])._index=t++,r.push(n)},remove:function(e,n){var a,o,f,u=r.length,s=Array(u-e),l=r;for(o=0;!n[o]&&o<u;++o)s[o]=r[o],l[o]=o;for(f=o;o<u;++o)a=r[o],n[o]?l[o]=-1:(l[o]=f,i[f]=i[o],t[f]=t[o],s[f]=a,a._index=f++),i[o]=0;return r=s,l},size:function(){return r.length},curr:function(){return i},prev:function(){return t},reset:function(e){t[e]=i[e]},all:function(){return e<257?255:e<65537?65535:4294967295},set:function(e,r){i[e]|=r},clear:function(e,r){i[e]&=~r},resize:function(r,n){(r>i.length||n>e)&&(e=Math.max(n,e),i=s(r,e,i),t=s(r,e))}}}function u(e,r,n){return e.length>=r?e:((n=n||new e.constructor(r)).set(e),n)}function s(e,r,n){var i=(r<257?t:r<65537?a:o)(e);return n&&i.set(n),i}function l(){var e=o(0),n=[],i=0;return{insert:function(r,t,a){if(!t.length)return[];var f,u,s,l=i,h=t.length,m=Array(h),v=o(h);for(s=0;s<h;++s)m[s]=r(t[s]),v[s]=s;if(m=d(m,v),l)f=n,u=e,n=Array(l+h),e=o(l+h),c(a,f,u,l,m,v,h,n,e);else{if(a>0)for(s=0;s<h;++s)v[s]+=a;n=m,e=v}return i=l+h,{index:v,value:m}},remove:function(r,t){var a,o,f,u=i;for(o=0;!t[e[o]]&&o<u;++o);for(f=o;o<u;++o)t[a=e[o]]||(e[f]=a,n[f]=n[o],++f);i=u-r},bisect:function(e,t){var a;return t?a=t.length:(t=n,a=i),[r.bisectLeft(t,e[0],0,a),r.bisectRight(t,e[1],0,a)]},reindex:function(r){for(var n=0,t=i;n<t;++n)e[n]=r[e[n]]},index:function(){return e},size:function(){return i}}}function d(e,n){return e.sort.call(n,function(r,n){var i=e[r],t=e[n];return i<t?-1:i>t?1:0}),r.permute(e,n)}function c(e,r,n,i,t,a,o,f,u){var s,l=0,d=0;for(s=0;l<i&&d<o;++s)r[l]<t[d]?(f[s]=r[l],u[s]=n[l++]):(f[s]=t[d],u[s]=a[d++]+e);for(;l<i;++l,++s)f[s]=r[l],u[s]=n[l];for(;d<o;++d,++s)f[s]=t[d],u[s]=a[d]+e}function h(e){n.Transform.call(this,f(),e),this._indices=null,this._dims=null}function m(e){n.Transform.call(this,null,e)}var v=function(e,r,n){var i=1<<r;return{one:i,zero:~i,range:n.slice(),bisect:e.bisect,index:e.index,size:e.size,onAdd:function(e,r){var n,t=this,a=t.bisect(t.range,e.value),o=e.index,f=a[0],u=a[1],s=o.length;for(n=0;n<f;++n)r[o[n]]|=i;for(n=u;n<s;++n)r[o[n]]|=i;return t}}};h.Definition={type:"CrossFilter",metadata:{},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"query",type:"array",array:!0,required:!0,content:{type:"number",array:!0,length:2}}]};var g=i.inherits(h,n.Transform);g.transform=function(e,r){return this._dims?e.modified("fields")||e.fields.some(function(e){return r.modified(e.fields)})?this.reinit(e,r):this.eval(e,r):this.init(e,r)},g.init=function(e,r){for(var n,i,t=e.fields,a=e.query,o=this._indices={},f=this._dims=[],u=a.length,s=0;s<u;++s)i=o[n=t[s].fname]||(o[n]=l()),f.push(v(i,s,a[s]));return this.eval(e,r)},g.reinit=function(e,r){var n,i,t,a,o,f,u,s,d,c=r.materialize().fork(),h=e.fields,m=e.query,g=this._indices,p=this._dims,y=this.value,x=y.curr(),_=y.prev(),b=y.all(),A=c.rem=c.add,q=c.mod,M=m.length,z={};if(_.set(x),r.rem.length&&(o=this.remove(e,r,c)),r.add.length&&y.add(r.add),r.mod.length)for(f={},u=0,s=(a=r.mod).length;u<s;++u)f[a[u]._index]=1;for(u=0;u<M;++u)d=h[u],(!p[u]||e.modified("fields",u)||r.modified(d.fields))&&((n=z[t=d.fname])||(g[t]=i=l(),z[t]=n=i.insert(d,r.source,0)),p[u]=v(i,u,m[u]).onAdd(n,x));for(u=0,s=y.data().length;u<s;++u)o[u]||(_[u]!==x[u]?A.push(u):f[u]&&x[u]!==b&&q.push(u));return y.mask=(1<<M)-1,c},g.eval=function(e,r){var n=r.materialize().fork(),i=this._dims.length,t=0;return r.rem.length&&(this.remove(e,r,n),t|=(1<<i)-1),e.modified("query")&&!e.modified("fields")&&(t|=this.update(e,r,n)),r.add.length&&(this.insert(e,r,n),t|=(1<<i)-1),r.mod.length&&(this.modify(r,n),t|=(1<<i)-1),this.value.mask=t,n},g.insert=function(e,r,n){var i,t,a,o=r.add,f=this.value,u=this._dims,s=this._indices,l=e.fields,d={},c=n.add,h=f.size(),m=h+o.length,v=u.length;f.resize(m,v),f.add(o);var g=f.curr(),p=f.prev(),y=f.all();for(i=0;i<v;++i)a=d[t=l[i].fname]||(d[t]=s[t].insert(l[i],o,h)),u[i].onAdd(a,g);for(;h<m;++h)p[h]=y,g[h]!==y&&c.push(h)},g.modify=function(e,r){var n,i,t,a=r.mod,o=this.value,f=o.curr(),u=o.all(),s=e.mod;for(n=0,i=s.length;n<i;++n)f[t=s[n]._index]!==u&&a.push(t)},g.remove=function(e,r,n){var i,t,a,o,f=this._indices,u=this.value,s=u.curr(),l=u.prev(),d=u.all(),c={},h=n.rem,m=r.rem;for(i=0,t=m.length;i<t;++i)c[a=m[i]._index]=1,l[a]=o=s[a],s[a]=d,o!==d&&h.push(a);for(a in f)f[a].remove(t,c);return this.reindex(r,t,c),c},g.reindex=function(e,r,n){var i=this._indices,t=this.value;e.runAfter(function(){var e=t.remove(r,n);for(var a in i)i[a].reindex(e)})},g.update=function(e,r,n){var i,t,a=this._dims,o=e.query,f=r.stamp,u=a.length,s=0;for(n.filters=0,t=0;t<u;++t)e.modified("query",t)&&(i=t,++s);if(1===s)s=a[i].one,this.incrementOne(a[i],o[i],n.add,n.rem);else for(t=0,s=0;t<u;++t)e.modified("query",t)&&(s|=a[t].one,this.incrementAll(a[t],o[t],f,n.add),n.rem=n.add);return s},g.incrementAll=function(e,r,n,i){var t,a,o,f=this.value,u=f.seen(),s=f.curr(),l=f.prev(),d=e.index(),c=e.bisect(e.range),h=e.bisect(r),m=h[0],v=h[1],g=c[0],p=c[1],y=e.one;if(m<g)for(t=m,a=Math.min(g,v);t<a;++t)u[o=d[t]]!==n&&(l[o]=s[o],u[o]=n,i.push(o)),s[o]^=y;else if(m>g)for(t=g,a=Math.min(m,p);t<a;++t)u[o=d[t]]!==n&&(l[o]=s[o],u[o]=n,i.push(o)),s[o]^=y;if(v>p)for(t=Math.max(m,p),a=v;t<a;++t)u[o=d[t]]!==n&&(l[o]=s[o],u[o]=n,i.push(o)),s[o]^=y;else if(v<p)for(t=Math.max(g,v),a=p;t<a;++t)u[o=d[t]]!==n&&(l[o]=s[o],u[o]=n,i.push(o)),s[o]^=y;e.range=r.slice()},g.incrementOne=function(e,r,n,i){var t,a,o,f=this.value.curr(),u=e.index(),s=e.bisect(e.range),l=e.bisect(r),d=l[0],c=l[1],h=s[0],m=s[1],v=e.one;if(d<h)for(t=d,a=Math.min(h,c);t<a;++t)f[o=u[t]]^=v,n.push(o);else if(d>h)for(t=h,a=Math.min(d,m);t<a;++t)f[o=u[t]]^=v,i.push(o);if(c>m)for(t=Math.max(d,m),a=c;t<a;++t)f[o=u[t]]^=v,n.push(o);else if(c<m)for(t=Math.max(h,c),a=m;t<a;++t)f[o=u[t]]^=v,i.push(o);e.range=r.slice()},m.Definition={type:"ResolveFilter",metadata:{},params:[{name:"ignore",type:"number",required:!0,description:"A bit mask indicating which filters to ignore."},{name:"filter",type:"object",required:!0,description:"Per-tuple filter bitmaps from a CrossFilter transform."}]},i.inherits(m,n.Transform).transform=function(e,r){var n=~(e.ignore||0),i=e.filter,t=i.mask;if(0==(t&n))return r.StopPropagation;var a=r.fork(r.ALL),o=i.data(),f=i.curr(),u=i.prev(),s=function(e){return f[e]&n?null:o[e]};return a.filter(a.MOD,s),t&t-1?(a.filter(a.ADD,function(e){var r=f[e]&n;return!r&&r^u[e]&n?o[e]:null}),a.filter(a.REM,function(e){var r=f[e]&n;return r&&!(r^r^u[e]&n)?o[e]:null})):(a.filter(a.ADD,s),a.filter(a.REM,function(e){return(f[e]&n)===t?o[e]:null})),a.filter(a.SOURCE,function(e){return s(e._index)})},e.crossfilter=h,e.resolvefilter=m,Object.defineProperty(e,"__esModule",{value:!0})});