!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-util"),require("vega-dataflow"),require("vega-expression"),require("vega-statistics"),require("d3-color"),require("d3-array"),require("d3-format"),require("d3-time-format"),require("vega-scale"),require("vega-scenegraph"),require("d3-geo"),require("vega-event-selector")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-dataflow","vega-expression","vega-statistics","d3-color","d3-array","d3-format","d3-time-format","vega-scale","vega-scenegraph","d3-geo","vega-event-selector"],t):t(e.vega=e.vega||{},e.vega,e.vega,e.vega,e.vega,e.d3,e.d3,e.d3,e.d3,e.vega,e.vega,e.d3,e.vega)}(this,function(e,t,n,a,i,r,o,l,s,u,d,f,c){"use strict";var p=function(e,n){return e=e||n.autosize,t.isObject(e)?e:{type:e=e||"pad"}},g=function(e,n){return e=e||n.padding,t.isObject(e)?{top:h(e.top),bottom:h(e.bottom),left:h(e.left),right:h(e.right)}:{top:a=h(e),bottom:a,left:a,right:a};var a};function h(e){return+e||0}var m=["value","update","react","bind"];function v(e,n){t.error(e+' for "outer" push: '+t.stringValue(n))}var y=function(e,t){var n=e.name;if("outer"===e.push)t.signals[n]||v("No prior signal definition",n),m.forEach(function(t){void 0!==e[t]&&v("Invalid property ",t)});else{var a=t.addSignal(n,e.value);!1===e.react&&(a.react=!1),e.bind&&t.addBinding(n,e.bind)}},b={};function x(e,t,n){var a=e+":"+n,i=b[a];return i&&i[0]===t||(b[a]=i=[t,t(n)]),i[1]}function k(e,t){return x("timeFormat",s.timeFormat,t)(e)}var S=new Date(2e3,0,1);function R(e,t,n){return S.setMonth(e),S.setDate(t),k(S,n)}function w(e,t,n){try{e[t].apply(e,["EXPRESSION"].concat([].slice.call(n)))}catch(t){e.warn(t)}return n[n.length-1]}var O="undefined"!=typeof window&&window||null;var z="Literal",P="Identifier",j="@",D="%",$=":";function E(e,n){var a;return t.isFunction(e)?e:t.isString(e)?(a=n.scales[e])&&a.value:void 0}function _(e,t,n){var a=D+n;if(!t.hasOwnProperty(a))try{t[a]=e.scaleRef(n)}catch(e){}}function V(e,t,n,a){if(t[0].type===z)_(n,a,t[0].value);else if(t[0].type===P)for(e in n.scales)_(n,a,e)}function F(e,t){return function(n,a,i){if(n){var r=E(n,(i||this).context);return r&&r.path[e](a)}return t(a)}}var A=F("area",f.geoArea),W=F("bounds",f.geoBounds),L=F("centroid",f.geoCentroid);function C(e){var t=this.context.data[e];return t?t.values.value:[]}function M(e,n,a,i){n[0].type!==z&&t.error("First argument to data functions must be a string literal.");var r=n[0].value,o=$+r;i.hasOwnProperty(o)||(i[o]=a.getData(r).tuplesRef())}var q={};function B(e){return e.data}function N(e,t){var n=C.call(t,e);return n.root&&n.root.lookup||q}var U=function(e,t,n,a){var i,r=t[0],o=t[t.length-1];return r>o&&(i=r,r=o,o=i),a=void 0===a||a,((n=void 0===n||n)?r<=e:r<e)&&(a?e<=o:e<o)};function T(e,n){return e===n||e!=e&&n!=n||!(!t.isArray(e)||!t.isArray(n)||e.length!==n.length)&&function(e,t){for(var n=0,a=e.length;n<a;++n)if(!T(e[n],t[n]))return!1;return!0}(e,n)}function I(e){return function(t){for(var n in e)if(!T(t[n],e[n]))return!1;return!0}}var X="bin_",H="intersect",Y="union",G="index:unit";function J(e,n){for(var a,i=n.fields,r=n.values,o=n.getter||(n.getter=[]),l=i.length,s=0;s<l;++s)if(o[s]=o[s]||t.field(i[s]),a=o[s](e),t.isDate(a)&&(a=t.toNumber(a)),t.isDate(r[s])&&(r[s]=t.toNumber(r[s])),n[X+i[s]]){if(t.isDate(r[s][0])&&(r[s]=r[s].map(t.toNumber)),!U(a,r[s],!0,!1))return!1}else if(a!==r[s])return!1;return!0}function K(e,n){for(var a,i,r=n.intervals,o=r.length,l=0;l<o;++l){if(a=r[l].extent,i=(r[l].getter||(r[l].getter=t.field(r[l].field)))(e),!a||a[0]===a[1])return!1;if(t.isDate(i)&&(i=t.toNumber(i)),t.isDate(a[0])&&(a=r[l].extent=a.map(t.toNumber)),t.isNumber(a[0])&&!U(i,a))return!1;if(t.isString(a[0])&&a.indexOf(i)<0)return!1}return!0}function Q(e,t,n,a){for(var i,r,o,l,s,u=this.context.data[e],d=u?u.values.value:[],f=u?u[G]&&u[G].value:void 0,c=n===H,p=d.length,g=0;g<p;++g)if(i=d[g],f&&c){if(-1===(o=(r=r||{})[l=i.unit]||0))continue;if(s=a(t,i),r[l]=s?-1:++o,s&&1===f.size)return!0;if(!s&&o===f.get(l).count)return!1}else if(c^(s=a(t,i)))return s;return p&&c}function Z(e,t,n){return Q.call(this,e,t,n,J)}function ee(e,n,a,i){n[0].type!==z&&t.error("First argument to indata must be a string literal.");var r=n[0].value,o=n.length>=2&&n[n.length-1].value,l=j+"unit";o!==H||i.hasOwnProperty(l)||(i[l]=a.getData(r).indataRef(a,"unit")),M(0,n,a,i)}function te(e,t,n,a){var i,r,o,l,s,u=this.context.data[e],d=u?u.values.value:[],f=u?u[G]&&u[G].value:void 0,c=d[0],p=0;if(c){for(i=t?c.encodings.length:c.fields.length;p<i;++p)if(t&&c.encodings[p]===t||n&&c.fields[p]===n){r=p,l=c[X+c.fields[p]];break}return f&&1===f.size&&(a=Y),f&&a===H?(s=d.reduce(function(e,t){return(e[t.unit]||(e[t.unit]=[])).push({unit:t.unit,value:t.values[r]}),e},{}),o=Object.keys(s).map(function(e){return{unit:e,value:l?ae(s[e],Y):ne(s[e],Y)}})):o=d.map(function(e){return{unit:e.unit,value:e.values[r]}}),l?ae(o,a):ne(o,a)}}function ne(e,t){for(var n,a,i,r,o={},l=0,s={},u=[],d=0,f=e.length;d<f;++d)a=(n=e[d]).unit,r=n.value,o[a]||(o[a]=++l),(i=s[r])||(s[r]=i={value:r,units:{},count:0}),i.units[a]||(i.units[a]=++i.count);for(r in s)i=s[r],t===H&&i.count!==l||u.push(i.value);return u.length?u:void 0}function ae(e,n){for(var a,i,r,o,l=n===H?re:ie,s=0,u=e.length;s<u;++s)a=e[s].value,t.isDate(a[0])&&(a=a.map(t.toNumber)),(r=a[0])>(o=a[1])&&(o=a[0],r=a[1]),i=i?l(i,r,o):[r,o];return i&&i.length&&+i[0]!=+i[1]?i:void 0}function ie(e,t,n){return e[0]>t&&(e[0]=t),e[1]<n&&(e[1]=n),e}function re(e,t,n){return n<e[0]||e[1]<t?[]:(e[0]<t&&(e[0]=t),e[1]>n&&(e[1]=n),e)}var oe={random:function(){return i.random()},isArray:t.isArray,isBoolean:t.isBoolean,isDate:t.isDate,isNumber:t.isNumber,isObject:t.isObject,isRegExp:t.isRegExp,isString:t.isString,isTuple:n.isTuple,toBoolean:t.toBoolean,toDate:t.toDate,toNumber:t.toNumber,toString:t.toString,pad:t.pad,peek:t.peek,truncate:t.truncate,rgb:r.rgb,lab:r.lab,hcl:r.hcl,hsl:r.hsl,sequence:o.range,format:function(e,t){return x("format",l.format,t)(e)},utcFormat:function(e,t){return x("utcFormat",s.utcFormat,t)(e)},utcParse:function(e,t){return x("utcParse",s.utcParse,t)(e)},timeFormat:k,timeParse:function(e,t){return x("timeParse",s.timeParse,t)(e)},monthFormat:function(e){return R(e,1,"%B")},monthAbbrevFormat:function(e){return R(e,1,"%b")},dayFormat:function(e){return R(0,2+e,"%A")},dayAbbrevFormat:function(e){return R(0,2+e,"%a")},quarter:function(e){return 1+~~(new Date(e).getMonth()/3)},utcquarter:function(e){return 1+~~(new Date(e).getUTCMonth()/3)},warn:function(){return w(this.context.dataflow,"warn",arguments)},info:function(){return w(this.context.dataflow,"info",arguments)},debug:function(){return w(this.context.dataflow,"debug",arguments)},inScope:function(e){var t=this.context.group,n=!1;if(t)for(;e;){if(e===t){n=!0;break}e=e.mark.group}return n},clampRange:function(e,t,n){var a,i=e[0],r=e[1];return r<i&&(a=r,r=i,i=a),(a=r-i)>=n-t?[t,n]:[Math.min(Math.max(i,t),n-a),Math.min(Math.max(r,a),n)]},pinchDistance:function(e){var t=e.touches,n=t[0].clientX-t[1].clientX,a=t[0].clientY-t[1].clientY;return Math.sqrt(n*n+a*a)},pinchAngle:function(e){var t=e.touches;return Math.atan2(t[0].clientY-t[1].clientY,t[0].clientX-t[1].clientX)},screen:function(){return O?O.screen:{}},containerSize:function(){var e=this.context.dataflow,t=e.container&&e.container();return t?[t.clientWidth,t.clientHeight]:[void 0,void 0]},windowSize:function(){return O?[O.innerWidth,O.innerHeight]:[void 0,void 0]},span:function(e){return e[e.length-1]-e[0]||0},flush:function(e,n,a,i,r,o){var l=Math.abs(n-e[0]),s=Math.abs(t.peek(e)-n);return l<s&&l<=a?i:s<=a?r:o},bandspace:function(e,t,n){return u.bandSpace(e||0,t||0,n||0)},inrange:U,setdata:function(e,n){var a=this.context.dataflow,i=this.context.data[e].input;return a.pulse(i,a.changeset().remove(t.truthy).insert(n)),1},pathShape:function(e){var t=null;return function(n){return n?d.pathRender(n,t=t||d.pathParse(e)):e}},panLinear:t.panLinear,panLog:t.panLog,panPow:t.panPow,zoomLinear:t.zoomLinear,zoomLog:t.zoomLog,zoomPow:t.zoomPow,encode:function(e,t,n){if(e){var a=this.context.dataflow,i=e.mark.source;a.pulse(i,a.changeset().encode(e,t))}return void 0!==n?n:e},modify:function(e,a,i,r,o,l){var s,u,d=this.context.dataflow,f=this.context.data[e],c=f.input,p=f.changes,g=d.stamp();if(!1===d._trigger||!(c.value.length||a||r))return 0;if((!p||p.stamp<g)&&(f.changes=p=d.changeset(),p.stamp=g,d.runAfter(function(){f.modified=!0,d.pulse(c,p).run()},!0,1)),i&&(s=!0===i?t.truthy:t.isArray(i)||n.isTuple(i)?i:I(i),p.remove(s)),a&&p.insert(a),r&&(s=I(r),c.value.some(s)?p.remove(s):p.insert(r)),o)for(u in l)p.modify(o,u,l[u]);return 1}},le=["view","item","group","xy","x","y"],se="event.vega.",ue="this.",de={};function fe(e,t,n){return 1===arguments.length?oe[e]:(oe[e]=t,n&&(de[e]=n),pe&&(pe.functions[e]=ue+e),this)}fe("bandwidth",function(e,t){var n=E(e,(t||this).context);return n&&n.bandwidth?n.bandwidth():0},V),fe("copy",function(e,t){var n=E(e,(t||this).context);return n?n.copy():void 0},V),fe("domain",function(e,t){var n=E(e,(t||this).context);return n?n.domain():[]},V),fe("range",function(e,t){var n=E(e,(t||this).context);return n&&n.range?n.range():[]},V),fe("invert",function(e,n,a){var i=E(e,(a||this).context);return i?t.isArray(n)?(i.invertRange||i.invert)(n):(i.invert||i.invertExtent)(n):void 0},V),fe("scale",function(e,t,n){var a=E(e,(n||this).context);return a?a(t):void 0},V),fe("gradient",function(e,t,n,a,i){e=E(e,(i||this).context);var r=d.Gradient(t,n),o=e.domain(),l=o[0],s=o[o.length-1],f=u.scaleFraction(e,l,s);e.ticks&&(l!==(o=e.ticks(+a||15))[0]&&o.unshift(l),s!==o[o.length-1]&&o.push(s));for(var c=0,p=o.length;c<p;++c)r.stop(f(o[c]),e(o[c]));return r},V),fe("geoArea",A,V),fe("geoBounds",W,V),fe("geoCentroid",L,V),fe("geoShape",function(e,t,n){var a=E(e,(n||this).context);return function(e){return a?a.path.context(e)(t):""}},V),fe("indata",function(e,t,n){var a=this.context.data[e]["index:"+t],i=a?a.value.get(n):void 0;return i?i.count:i},function(e,n,a,i){n[0].type!==z&&t.error("First argument to indata must be a string literal."),n[1].type!==z&&t.error("Second argument to indata must be a string literal.");var r=n[0].value,o=n[1].value,l=j+o;i.hasOwnProperty(l)||(i[l]=a.getData(r).indataRef(a,o))}),fe("data",C,M),fe("vlSingle",Z,M),fe("vlSingleDomain",te,M),fe("vlMulti",Z,ee),fe("vlMultiDomain",te,ee),fe("vlInterval",function(e,t,n){return Q.call(this,e,t,n,K)},M),fe("vlIntervalDomain",function(e,t,n,a){var i,r,o,l,s,u=this.context.data[e],d=u?u.values.value:[],f=d[0],c=0;if(f){for(i=f.intervals.length;c<i;++c)if(r=f.intervals[c],t&&r.encoding===t||n&&r.field===n){if(!r.extent)return;o=c,s=r.extent.length>2;break}return l=d.reduce(function(e,t){var n=t.intervals[o].extent,a=s?n.map(function(e){return{unit:t.unit,value:e}}):{unit:t.unit,value:n};return s?e.push.apply(e,a):e.push(a),e},[]),s?ne(l,a):ae(l,a)}},M),fe("treePath",function(e,t,n){var a=N(e,this),i=a[t],r=a[n];return i&&r?i.path(r).map(B):void 0},M),fe("treeAncestors",function(e,t){var n=N(e,this)[t];return n?n.ancestors().map(B):void 0},M);var ce={blacklist:["_"],whitelist:["datum","event","item"],fieldvar:"datum",globalvar:function(e){return"_["+t.stringValue("$"+e)+"]"},functions:function(e){var t=a.functions(e);for(var n in le.forEach(function(e){t[e]=se+e}),oe)t[n]=ue+n;return t},constants:a.constants,visitors:de},pe=a.codegen(ce),ge=function(e,n,i){var r,o,l={};try{r=a.parse(e)}catch(n){t.error("Expression parse error: "+t.stringValue(e))}return r.visit(function(e){if("CallExpression"===e.type){var t=e.callee.name,a=ce.visitors[t];a&&a(t,e.arguments,n,l)}}),(o=pe(r)).globals.forEach(function(e){var t="$"+e;!l.hasOwnProperty(t)&&n.getSignal(e)&&(l[t]=n.signalRef(e))}),{$expr:i?i+"return("+o.code+");":o.code,$fields:o.fields,$params:l}};function he(e,t,n,a){this.id=-1,this.type=e,this.value=t,this.params=n,a&&(this.parent=a)}function me(e,t,n,a){return new he(e,t,n,a)}function ve(e,t){return me("operator",e,t)}function ye(e){var t={$ref:e.id};return e.id<0&&(e.refs=e.refs||[]).push(t),t}var be={$tupleid:1,toString:function(){return":_tupleid_:"}};function xe(e,t){return t?{$field:e,$name:t}:{$field:e}}var ke=xe("key");function Se(e,t){return{$compare:e,$order:t}}var Re="descending";function we(e,t){return(e&&e.signal?"$"+e.signal:e||"")+(e&&t?"_":"")+(t&&t.signal?"$"+t.signal:t||"")}var Oe="scope",ze="view";function Pe(e){return e&&e.signal}function je(e,t){return null!=e?e:t}var De=function(e,t){return e.signal?t.getSignal(e.signal).id:e.scale?t.getScale(e.scale).id:$e(e,t)};function $e(e,n){return(e.merge?Ee:e.stream?_e:e.type?Ve:t.error("Invalid stream specification: "+t.stringValue(e)))(e,n)}function Ee(e,t){var n=Fe({merge:e.merge.map(function(e){return $e(e,t)})},e,t);return t.addStream(n).id}function _e(e,t){var n=Fe({stream:$e(e.stream,t)},e,t);return t.addStream(n).id}function Ve(e,t){var n,a=t.event((n=e.source)===Oe?ze:n||ze,e.type),i=Fe({stream:a},e,t);return 1===Object.keys(i).length?a:t.addStream(i).id}function Fe(e,n,a){var i,r,o,l,s=n.between;return s&&(2!==s.length&&t.error('Stream "between" parameter must have 2 entries: '+t.stringValue(n)),e.between=[$e(s[0],a),$e(s[1],a)]),s=n.filter?t.array(n.filter):[],(n.marktype||n.markname||n.markrole)&&s.push((i=n.marktype,r=n.markname,o=n.markrole,(l="event.item")+(i&&"*"!==i?"&&"+l+".mark.marktype==='"+i+"'":"")+(o?"&&"+l+".mark.role==='"+o+"'":"")+(r?"&&"+l+".mark.name==='"+r+"'":""))),n.source===Oe&&s.push("inScope(event.item)"),s.length&&(e.filter=ge("("+s.join(")&&(")+")").$expr),null!=(s=n.throttle)&&(e.throttle=+s),null!=(s=n.debounce)&&(e.debounce=+s),n.consume&&(e.consume=!0),e}var Ae="var datum=event.item&&event.item.datum;",We=function(e,n){var a=n.getSignal(e.name);if(e.update){var i=ge(e.update,n);a.update=i.$expr,a.params=i.$params}e.on&&e.on.forEach(function(e){var i,r,o,l,s,u,d,f,p;i=e,r=n,o=a.id,u=i.events,d=i.update,f=i.encode,p=[],u||t.error("Signal update missing events specification."),t.isString(u)&&(u=c.selector(u,r.isSubscope()?Oe:ze)),(u=t.array(u).filter(function(e){return e.signal||e.scale?(p.push(e),0):1})).length&&p.push(u.length>1?{merge:u}:u[0]),null!=f&&(d&&t.error("Signal encode and update are mutually exclusive."),d="encode(item(),"+t.stringValue(f)+")"),l=t.isString(d)?ge(d,r,Ae):null!=d.expr?ge(d.expr,r,Ae):null!=d.value?d.value:null!=d.signal?{$expr:"_.value",$params:{value:r.signalRef(d.signal)}}:t.error("Invalid signal update specification."),s={target:o,update:l},i.force&&(s.options={force:!0}),p.forEach(function(e){e={source:De(e,r)},r.addUpdate(t.extend(e,s))})})};function Le(e){return function(t,n,a){return me(e,n,t||void 0,a)}}var Ce=Le("aggregate"),Me=Le("axisticks"),qe=Le("bound"),Be=Le("collect"),Ne=Le("compare"),Ue=Le("datajoin"),Te=Le("encode"),Ie=Le("facet"),Xe=Le("field"),He=Le("key"),Ye=Le("legendentries"),Ge=Le("mark"),Je=Le("multiextent"),Ke=Le("multivalues"),Qe=Le("overlap"),Ze=Le("params"),et=Le("prefacet"),tt=Le("projection"),nt=Le("proxy"),at=Le("relay"),it=Le("render"),rt=Le("scale"),ot=Le("sieve"),lt=Le("sortitems"),st=Le("viewlayout"),ut=Le("values"),dt=0,ft=["identity","ordinal","band","point","bin-linear","bin-ordinal","linear","pow","sqrt","log","sequential","time","utc","quantize","quantile","threshold"],ct=t.toSet(ft),pt=t.toSet(ft.slice(1,6));function gt(e){return pt.hasOwnProperty(e)}function ht(e){return"quantile"===e}function mt(e,n){var a,i,r,o,l=n.getScale(e.name).params;for(a in l.domain=bt(e.domain,e,n),null!=e.range&&(l.range=function e(n,a,i){var r=n.range,o=a.config.range;{if(r.signal)return a.signalRef(r.signal);if(t.isString(r)){if(o&&o.hasOwnProperty(r))return n=t.extend({},n,{range:o[r]}),e(n,a,i);"width"===r?r=[0,{signal:"width"}]:"height"===r?r=gt(n.type)?[0,{signal:"height"}]:[{signal:"height"},0]:t.error("Unrecognized scale range value: "+t.stringValue(r))}else{if(r.scheme)return i.scheme=vt(r.scheme,a),r.extent&&(i.schemeExtent=(l=r.extent,s=a,l.signal?s.signalRef(l.signal):l.map(function(e){return vt(e,s)}))),void(r.count&&(i.schemeCount=vt(r.count,a)));if(r.step)return void(i.rangeStep=vt(r.step,a));if(gt(n.type)&&!t.isArray(r))return bt(r,n,a);t.isArray(r)||t.error("Unsupported range type: "+t.stringValue(r))}}var l,s;return r.map(function(e){return vt(e,a)})}(e,n,l)),null!=e.interpolate&&(i=e.interpolate,(r=l).interpolate=vt(i.type||i),null!=i.gamma&&(r.interpolateGamma=vt(i.gamma))),null!=e.nice&&(o=e.nice,l.nice=t.isObject(o)?{interval:vt(o.interval),step:vt(o.step)}:vt(o)),e)l.hasOwnProperty(a)||"name"===a||(l[a]=vt(e[a],n))}function vt(e,n){return t.isObject(e)?e.signal?n.signalRef(e.signal):t.error("Unsupported object: "+t.stringValue(e)):e}function yt(e){t.error("Can not find data set: "+t.stringValue(e))}function bt(e,n,a){if(e)return e.signal?a.signalRef(e.signal):(t.isArray(e)?function(e,t,n){return e.map(function(e){return vt(e,n)})}:e.fields?function(e,n,a){var i=e.data,r=e.fields.reduce(function(e,n){return n=t.isString(n)?{data:i,field:n}:t.isArray(n)||n.signal?function(e,n){var a="_:vega:_"+dt++,i=Be({});if(t.isArray(e))i.value={$ingest:e};else if(e.signal){var r="setdata("+t.stringValue(a)+","+e.signal+")";i.params.input=n.signalRef(r)}return n.addDataPipeline(a,[i,ot({})]),{data:a,field:"data"}}(n,a):n,e.push(n),e},[]);return(gt(n.type)?function(e,t,n){var a,i,r;return a=n.map(function(e){var n=t.getData(e.data);return n||yt(e.data),n.countsRef(t,e.field)}),i=t.add(Ce({groupby:ke,ops:["sum"],fields:[t.fieldRef("count")],as:["count"],pulse:a})),r=t.add(Be({pulse:ye(i)})),ye(t.add(ut({field:ke,sort:t.sortRef(xt(e.sort,!0)),pulse:ye(r)})))}:ht(n.type)?function(e,t,n){var a=n.map(function(e){var n=t.getData(e.data);return n||yt(e.data),n.domainRef(t,e.field)});return ye(t.add(Ke({values:a})))}:function(e,t,n){var a=n.map(function(e){var n=t.getData(e.data);return n||yt(e.data),n.extentRef(t,e.field)});return ye(t.add(Je({extents:a})))})(e,a,r)}:function(e,t,n){var a=n.getData(e.data);a||yt(e.data);return gt(t.type)?a.valuesRef(n,e.field,xt(e.sort,!1)):ht(t.type)?a.domainRef(n,e.field):a.extentRef(n,e.field)})(e,n,a);null==n.domainMin&&null==n.domainMax||t.error("No scale domain defined for domainMin/domainMax to override.")}function xt(e,n){return e&&(e.field||e.op?e.field||"count"===e.op?n&&e.field?t.error("Multiple domain scales can not sort by field."):n&&e.op&&"count"!==e.op&&t.error("Multiple domain scales support op count only."):t.error("No field provided for sort aggregate op: "+e.op):t.isObject(e)?e.field="key":e={field:"key"}),e}function kt(e,n,a){return t.isArray(e)?e.map(function(e){return kt(e,n,a)}):t.isObject(e)?e.signal?a.signalRef(e.signal):"fit"===n?e:t.error("Unsupported parameter object: "+t.stringValue(e)):e}var St="top",Rt="left",wt="bottom",Ot="label",zt="perc",Pt="value",jt="guide-label",Dt="guide-title",$t="group-title",Et=["shape","size","fill","stroke","strokeDash","opacity"],_t={name:1,interactive:1},Vt=t.toSet(["rule"]),Ft=t.toSet(["group","image","rect"]),At=function(e,t){var n="";return Vt[t]?n:(e.x2&&(e.x?(Ft[t]&&(n+="if(o.x>o.x2)$=o.x,o.x=o.x2,o.x2=$;"),n+="o.width=o.x2-o.x;"):n+="o.x=o.x2-(o.width||0);"),e.xc&&(n+="o.x=o.xc-(o.width||0)/2;"),e.y2&&(e.y?(Ft[t]&&(n+="if(o.y>o.y2)$=o.y,o.y=o.y2,o.y2=$;"),n+="o.height=o.y2-o.y;"):n+="o.y=o.y2-(o.height||0);"),e.yc&&(n+="o.y=o.yc-(o.height||0)/2;"),n)},Wt=function(e,n,a,i){var r=ge(e,n);return r.$fields.forEach(function(e){i[e]=1}),t.extend(a,r.$params),r.$expr},Lt=function(e,n,a,i){return function e(n,a,i,r){var o,l,s;if(n.signal)o="datum",s=Wt(n.signal,a,i,r);else if(n.group||n.parent){for(l=Math.max(1,n.level||1),o="item";l-- >0;)o+=".mark.group";n.parent?(s=n.parent,o+=".datum"):s=n.group}else n.datum?(o="datum",s=n.datum):t.error("Invalid field reference: "+t.stringValue(n));n.signal||(t.isString(s)?(r[s]=1,s=t.splitAccessPath(s).map(t.stringValue).join("][")):s=e(s,a,i,r));return o+"["+s+"]"}(t.isObject(e)?e:{datum:e},n,a,i)};var Ct=function(e,n,a,i,r){var o,l,s,u=Mt(e.scale,a,i,r);return null!=e.range?(l=u+".range()",n=0===(o=+e.range)?l+"[0]":"($="+l+","+(1===o?"$[$.length-1]":"$[0]+"+o+"*($[$.length-1]-$[0])")+")"):(void 0!==n&&(n=u+"("+n+")"),e.band&&(s=function(e,n){if(!t.isString(e))return-1;var a=n.scaleType(e);return"band"===a||"point"===a?1:0}(e.scale,a))&&(o=(l=u+".bandwidth")+"()"+(1===(o=+e.band)?"":"*"+o),s<0&&(o="("+l+"?"+o+":0)"),n=(n?n+"+":"")+o,e.extra&&(n="(datum.extra?"+u+"(datum.extra.value):"+n+")")),null==n&&(n="0")),n};function Mt(e,n,a,i){var r;if(t.isString(e))r=D+e,a.hasOwnProperty(r)||(a[r]=n.scaleRef(e)),r=t.stringValue(r);else{for(r in n.scales)a[D+r]=n.scaleRef(r);r=t.stringValue(D)+"+"+(e.signal?"("+Wt(e.signal,n,a,i)+")":Lt(e,n,a,i))}return"_["+r+"]"}var qt=function(e,n,a,i){return t.isObject(e)?"("+Bt(null,e,n,a,i)+")":e},Bt=function(e,n,a,i,r){if(null!=n.gradient)return l=a,s=i,u=r,"this.gradient("+Mt((o=n).gradient,l,s,u)+","+t.stringValue(o.start)+","+t.stringValue(o.stop)+","+t.stringValue(o.count)+")";var o,l,s,u,d=n.signal?Wt(n.signal,a,i,r):n.color?function(e,t,n,a){function i(e,i,r,o){return"this."+e+"("+[Bt(null,i,t,n,a),Bt(null,r,t,n,a),Bt(null,o,t,n,a)].join(",")+").toString()"}return e.c?i("hcl",e.h,e.c,e.l):e.h||e.s?i("hsl",e.h,e.s,e.l):e.l||e.a?i("lab",e.l,e.a,e.b):e.r||e.g||e.b?i("rgb",e.r,e.g,e.b):null}(n.color,a,i,r):null!=n.field?Lt(n.field,a,i,r):void 0!==n.value?t.stringValue(n.value):void 0;return null!=n.scale&&(d=Ct(n,d,a,i,r)),void 0===d&&(d=null),null!=n.exponent&&(d="Math.pow("+d+","+qt(n.exponent,a,i,r)+")"),null!=n.mult&&(d+="*"+qt(n.mult,a,i,r)),null!=n.offset&&(d+="+"+qt(n.offset,a,i,r)),n.round&&(d="Math.round("+d+")"),d},Nt=function(e,n,a){return e+"["+t.stringValue(n)+"]="+a+";"},Ut=function(e,t,n,a,i){var r="";return t.forEach(function(t){var o=Bt(e,t,n,a,i);r+=t.test?Wt(t.test,n,a,i)+"?"+o+":":o}),Nt("o",e,r)};function Tt(e,n,a,i){var r,o,l,s={},u="var o=item,datum=o.datum,$;";for(r in e)o=e[r],t.isArray(o)?u+=Ut(r,o,i,a,s):(l=Bt(r,o,i,a,s),u+=Nt("o",r,l));return u+=At(e,n),{$expr:u+="return 1;",$fields:Object.keys(s),$output:Object.keys(e)}}var It="mark",Xt="frame",Ht="scope",Yt="axis-domain",Gt="axis-grid",Jt="axis-label",Kt="axis-tick",Qt="axis-title",Zt="legend-entry",en="legend-label",tn="legend-symbol",nn="legend-title",an="title";function rn(e){return t.isObject(e)?e:{value:e}}function on(e,n,a){return null!=a?(e[n]=t.isObject(a)&&!t.isArray(a)?a:{value:a},1):0}function ln(e,n,a){for(var i in n)a&&a.hasOwnProperty(i)||(e[i]=t.extend(e[i]||{},n[i]));return e}function sn(e,n,a,i,r,o){var l,s;for(s in(o=o||{}).encoders={$encode:l={}},e=function(e,n,a,i,r){var o,l,s={};"legend"!=a&&0!==String(a).indexOf("axis")||(a=null);for(o in l=a===Xt?r.group:a===It?t.extend({},r.mark,r[n]):null)un(o,e)||("fill"===o||"stroke"===o)&&(un("fill",e)||un("stroke",e))||(s[o]={value:l[o]});return t.array(i).forEach(function(t){var n=r.style&&r.style[t];for(var a in n)un(a,e)||(s[a]={value:n[a]})}),(e=t.extend({},e)).enter=t.extend(s,e.enter),e}(e,n,a,i,r.config))l[s]=Tt(e[s],n,o,r);return o}function un(e,t){return t&&(t.enter&&t.enter[e]||t.update&&t.update[e])}var dn=function(e,t,n,a,i,r,o){return{type:e,name:o?o.name:void 0,role:t,style:o&&o.style||n,key:a,from:i,interactive:!(!o||!o.interactive),encode:ln(r,o,_t)}},fn="group",cn="rule",pn="text",gn=function(e,t,n,a,i,r,o){return{type:fn,name:n,role:e,style:t,from:a,interactive:i||!1,encode:r,marks:o}};function hn(e){return t.isObject(e)&&e.signal?e.signal:t.stringValue(e)}var mn=function(e){var t=e.role||"";return t.indexOf("axis")&&t.indexOf("legend")?e.type===fn?Ht:t||It:t},vn=function(e,a){var i=n.definition(e.type);i||t.error("Unrecognized transform type: "+t.stringValue(e.type));var r=me(i.type.toLowerCase(),null,yn(i,e,a));return e.signal&&a.addSignal(e.signal,a.proxy(r)),r.metadata=i.metadata||{},r};function yn(e,t,n){var a,i,r,o={};for(i=0,r=e.params.length;i<r;++i)o[(a=e.params[i]).name]=bn(a,t,n);return o}function bn(e,n,a){var i,r,o,l=e.type,s=n[e.name];if("index"===l)return function(e,n,a){t.isString(n.from)||t.error('Lookup "from" parameter must be a string literal.');return a.getData(n.from).lookupRef(a,n.key)}(0,n,a);{if(void 0!==s)return"param"===l?(r=a,o=n[(i=e).name],i.array?(t.isArray(o)||t.error("Expected an array of sub-parameters. Instead: "+t.stringValue(o)),o.map(function(e){return kn(i,e,r)})):kn(i,o,r)):"projection"===l?a.projectionRef(n[e.name]):e.array&&!Pe(s)?s.map(function(t){return xn(e,t,a)}):xn(e,s,a);e.required&&t.error("Missing required "+t.stringValue(n.type)+" parameter: "+t.stringValue(e.name))}}function xn(e,n,a){var i=e.type;if(Pe(n))return Sn(i)?t.error("Expression references can not be signals."):Rn(i)?a.fieldRef(n):wn(i)?a.compareRef(n):a.signalRef(n.signal);var r,o,l=e.expr||Rn(i);return l&&((o=n)&&o.expr)?ge(n.expr,a):l&&((r=n)&&r.field)?xe(n.field):Sn(i)?ge(n,a):"data"===i?ye(a.getData(n).values):Rn(i)?xe(n):wn(i)?a.compareRef(n):n}function kn(e,n,a){var i,r,o,l,s;for(l=0,s=e.params.length;l<s;++l){for(o in(r=e.params[l]).key)if(r.key[o]!==n[o]){r=null;break}if(r)break}return r||t.error("Unsupported parameter: "+t.stringValue(n)),i=t.extend(yn(r,n,a),r.key),ye(a.add(Ze(i)))}function Sn(e){return"expr"===e}function Rn(e){return"field"===e}function wn(e){return"compare"===e}function On(e,t,n,a,i){this.scope=e,this.input=t,this.output=n,this.values=a,this.aggregate=i,this.index={}}On.fromEntries=function(e,t){var n=t.length,a=1,i=t[0],r=t[n-1],o=t[n-2],l=null;for(e.add(t[0]);a<n;++a)t[a].params.pulse=ye(t[a-1]),e.add(t[a]),"aggregate"===t[a].type&&(l=t[a]);return new On(e,i,o,r,l)};var zn=On.prototype;function Pn(e){return t.isString(e)?e:null}function jn(e,t,n){var a,i=we(n.op,n.field);if(t.ops){for(var r=0,o=t.as.length;r<o;++r)if(t.as[r]===i)return}else t.ops=["count"],t.fields=[null],t.as=["count"];n.op&&(t.ops.push((a=n.op.signal)?e.signalRef(a):n.op),t.fields.push(e.fieldRef(n.field)),t.as.push(i))}function Dn(e,n,a,i,r,o,l){var s,u,d,f=n[a]||(n[a]={}),c=(d=o,t.isObject(d)?(d.order===Re?"-":"+")+we(d.op,d.field):""),p=Pn(r);if(null!=p&&(e=n.scope,s=f[p+=c?"|"+c:""]),!s){var g=o?{field:ke,pulse:n.countsRef(e,r,o)}:{field:e.fieldRef(r),pulse:ye(n.output)};c&&(g.sort=e.sortRef(o)),u=e.add(me(i,void 0,g)),l&&(n.index[r]=u),s=ye(u),null!=p&&(f[p]=s)}return s}zn.countsRef=function(e,t,n){var a,i,r,o=this.counts||(this.counts={}),l=Pn(t);return null!=l&&(e=this.scope,a=o[l]),a?n&&n.field&&jn(e,a.agg.params,n):(r={groupby:e.fieldRef(t,"key"),pulse:ye(this.output)},n&&n.field&&jn(e,r,n),a={agg:i=e.add(Ce(r)),ref:ye(a=e.add(Be({pulse:ye(i)})))},null!=l&&(o[l]=a)),a.ref},zn.tuplesRef=function(){return ye(this.values)},zn.extentRef=function(e,t){return Dn(e,this,"extent","extent",t,!1)},zn.domainRef=function(e,t){return Dn(e,this,"domain","values",t,!1)},zn.valuesRef=function(e,t,n){return Dn(e,this,"vals","values",t,n||!0)},zn.lookupRef=function(e,t){return Dn(e,this,"lookup","tupleindex",t,!1)},zn.indataRef=function(e,t){return Dn(e,this,"indata","tupleindex",t,!0,!0)};var $n=function(e,t,n){var a,i,r=e.remove,o=e.insert,l=e.toggle,s=e.modify,u=e.values,d=t.add(ve());a="if("+e.trigger+',modify("'+n+'",'+[o,r,l,s,u].map(function(e){return null==e?"null":e}).join(",")+"),0)",i=ge(a,t),d.update=i.$expr,d.params=i.$params},En=function(e,n){var a,i,r,o,l,s,u,d,f,c,p,g,h,m,v,y,b,x,k,S,R,w,O,z,P,j,D,$,E,_,V,F,A,W,L,C,M,q,B,N,U,T,I=mn(e),X=e.type===fn,H=e.from&&e.from.facet,Y=e.layout||I===Ht||I===Xt,G=I===It||Y||H,J=e.overlap;m=e.from,v=X,y=n,m?(b=m.facet)&&(v||t.error("Only group marks can be faceted."),null!=b.field?S=R=ye(y.getData(b.data).output):(m.data?R=ye(y.getData(m.data).aggregate):((k=vn(t.extend({type:"aggregate",groupby:t.array(b.groupby)},b.aggregate),y)).params.key=y.keyRef(b.groupby),k.params.pulse=ye(y.getData(b.data).output),S=R=ye(y.add(k))),x=y.keyRef(b.groupby,!0))):S=ye(y.add(Be(null,[{}]))),S||(S=m.$ref?m:ye(y.getData(m.data).output)),r={key:x,pulse:S,parent:R},f=ye(i=n.add(Ue({key:r.key||(e.key?xe(e.key):void 0),pulse:r.pulse,clean:!X}))),i=o=n.add(Be({pulse:f})),c=ye(i=n.add(Ge({markdef:(D=e,{marktype:D.type,name:D.name||void 0,role:D.role||mn(D),zindex:+D.zindex||void 0}),interactive:(P=e.interactive,j=n,P&&P.signal?j.signalRef(P.signal):!1!==P),clip:(w=e.clip,O=n,t.isObject(w)&&(w.signal?z=w.signal:w.path?z="pathShape("+hn(w.path)+")":w.sphere&&(z="geoShape("+hn(w.sphere)+', {type: "Sphere"})')),z?O.signalRef(z):!!w),context:{$context:!0},groups:n.lookup(),parent:n.signals.parent?n.signalRef("parent"):null,index:n.markpath(),pulse:ye(i)}))),(i=n.add(Te(sn(e.encode,e.type,I,e.style,n,{pulse:c})))).params.parent=n.encode(),e.transform&&e.transform.forEach(function(e){var a=vn(e,n);(a.metadata.generates||a.metadata.changes)&&t.error("Mark transforms should not generate new data."),a.params.pulse=ye(i),n.add(i=a)}),e.sort&&(i=n.add(lt({sort:n.compareRef(e.sort,!0),pulse:ye(i)}))),p=ye(i),(H||Y)&&(g=ye(Y=n.add(st({layout:n.objectProperty(e.layout),legendMargin:n.config.legendMargin,mark:c,pulse:p})))),h=ye(l=n.add(qe({mark:c,pulse:g||p}))),X&&(G&&((a=n.operators).pop(),Y&&a.pop()),n.pushState(p,g||h,f),H?(W=n,L=r,N=(A=e).from.facet,U=N.name,T=ye(W.getData(N.data).output),N.name||t.error("Facet must have a name: "+t.stringValue(N)),N.data||t.error("Facet must reference a data set: "+t.stringValue(N)),N.field?B=W.add(et({field:W.fieldRef(N.field),pulse:T})):N.groupby?B=W.add(Ie({key:W.keyRef(N.groupby),group:ye(W.proxy(L.parent)),pulse:T})):t.error("Facet must specify groupby or field: "+t.stringValue(N)),M=(C=W.fork()).add(Be()),q=C.add(ot({pulse:ye(M)})),C.addData(U,new On(C,M,M,q)),C.addSignal("parent",null),B.params.subflow={$subflow:Bn(A,C).toRuntime()}):G?($=e,_=r,V=(E=n).add(et({pulse:_.pulse})),(F=E.fork()).add(ot()),F.addSignal("parent",null),V.params.subflow={$subflow:Bn($,F).toRuntime()}):Bn(e,n),n.popState(),G&&(Y&&a.push(Y),a.push(l))),J&&(i={method:!0===J.method?"parity":J.method,pulse:h},J.order&&(i.sort=n.compareRef({field:J.order})),J.bound&&(i.boundScale=n.scaleRef(J.bound.scale),i.boundOrient=J.bound.orient,i.boundTolerance=J.bound.tolerance),h=ye(n.add(Qe(i)))),s=n.add(it({pulse:h})),u=n.add(ot({pulse:ye(s)},void 0,n.parent())),null!=e.name&&(d=e.name,n.addData(d,new On(n,o,s,u)),e.on&&e.on.forEach(function(e){(e.insert||e.remove||e.toggle)&&t.error("Marks only support modify triggers."),$n(e,n,d)}))},_n=function(e,n){var a,i,r,o,l,s,u,d,f,c,p,g,h,m,v,y,b,x,k,S,R,w,O,z,P,j,D,$,E,_,V,F,A,W,L,C,M,q,B,N,U,T,I,X,H,Y,G,J,K,Q,Z,ee,te=e.type||"symbol",ne=n.config.legend,ae=e.encode||{},ie=ae.legend||{},re=ie.name||void 0,oe=ie.interactive,le=ie.style,se=e.size||e.shape||e.fill||e.stroke||e.strokeDash||e.opacity;return se||t.error("Missing valid scale for legend."),a={orient:je(e.orient,ne.orient),title:null!=e.title},i=ye(n.add(Be(null,[a]))),ie=ln({enter:(f=ne,c={},on(c,"fill",f.fillColor)+on(c,"stroke",f.strokeColor)+on(c,"strokeWidth",f.strokeWidth)+on(c,"strokeDash",f.strokeDash)+on(c,"cornerRadius",f.cornerRadius)?c:void 0),update:{offset:rn(je(e.offset,ne.offset)),padding:rn(je(e.padding,ne.padding)),titlePadding:rn(je(e.titlePadding,ne.titlePadding))}},ie,_t),s={update:{x:{field:{group:"padding"}},y:{field:{group:"padding"}},entryPadding:rn(je(e.entryPadding,ne.entryPadding))}},"gradient"===te?(r=ye(n.add(Ye({type:"gradient",scale:n.scaleRef(se),count:n.objectProperty(e.tickCount),values:n.objectProperty(e.values),formatSpecifier:n.property(e.format)}))),d=[(q=se,B=ne,N=ae.gradient,I={value:0},X={},X.enter=U={opacity:I,x:I,y:I},on(U,"width",B.gradientWidth),on(U,"height",B.gradientHeight),on(U,"stroke",B.gradientStrokeColor),on(U,"strokeWidth",B.gradientStrokeWidth),X.exit={opacity:I},X.update=T={x:I,y:I,fill:{gradient:q,start:[0,0],stop:[1,0]},opacity:{value:1}},on(T,"width",B.gradientWidth),on(T,"height",B.gradientHeight),dn("rect","legend-gradient",null,void 0,void 0,X,N)),(V=ne,F=ae.labels,A=r,C={value:0},M={},M.enter=W={opacity:C},on(W,"fill",V.labelColor),on(W,"font",V.labelFont),on(W,"fontSize",V.labelFontSize),on(W,"fontWeight",V.labelFontWeight),on(W,"baseline",V.gradientLabelBaseline),on(W,"limit",V.gradientLabelLimit),M.exit={opacity:C},M.update=L={opacity:{value:1},text:{field:Ot}},W.x=L.x={field:zt,mult:V.gradientWidth},W.y=L.y={value:V.gradientHeight,offset:V.gradientLabelOffset},W.align=L.align={signal:'datum.perc<=0?"left":datum.perc>=1?"right":"center"'},dn(pn,en,jt,zt,A,M,F))]):(r=ye(n.add(Ye(u={scale:n.scaleRef(se),count:n.objectProperty(e.tickCount),values:n.objectProperty(e.values),formatSpecifier:n.property(e.format)}))),d=[(O=e,z=ne,P=ae.symbols,j=r,E={value:0},_={},_.enter=D={opacity:E},on(D,"shape",z.symbolType),on(D,"size",z.symbolSize),on(D,"strokeWidth",z.symbolStrokeWidth),O.fill||(on(D,"fill",z.symbolFillColor),on(D,"stroke",z.symbolStrokeColor)),_.exit={opacity:E},_.update=$={opacity:{value:1}},D.x=$.x={field:"offset",mult:.5},D.y=$.y={field:"size",mult:.5,offset:{field:"total",offset:{field:{group:"entryPadding"},mult:{field:"index"}}}},Et.forEach(function(e){O[e]&&($[e]=D[e]={scale:O[e],field:Pt})}),dn("symbol",tn,null,Pt,j,_,P)),(y=ne,b=ae.labels,x=r,R={value:0},w={},w.enter=k={opacity:R},on(k,"align",y.labelAlign),on(k,"baseline",y.labelBaseline),on(k,"fill",y.labelColor),on(k,"font",y.labelFont),on(k,"fontSize",y.labelFontSize),on(k,"fontWeight",y.labelFontWeight),on(k,"limit",y.labelLimit),w.exit={opacity:R},w.update=S={opacity:{value:1},text:{field:Ot}},k.x=S.x={field:"offset",offset:y.labelOffset},k.y=S.y={field:"size",mult:.5,offset:{field:"total",offset:{field:{group:"entryPadding"},mult:{field:"index"}}}},dn(pn,en,jt,Pt,x,w,b))],u.size=(p=e,g=n,m=Fn("fontSize",(h=d)[1].encode,g,jt),v="max(ceil(sqrt("+(p.size?'scale("'+p.size+'",datum)':Vn(Fn("size",h[0].encode,g)))+")),"+Vn(m)+")",ge(v,g))),d=[gn(Zt,null,null,i,oe,s,d)],a.title&&(H=e,Y=ne,G=ae.title,J=i,Q={value:0},Z=H.title,(ee={}).enter=K={x:{field:{group:"padding"}},y:{field:{group:"padding"}},opacity:Q},on(K,"align",Y.titleAlign),on(K,"baseline",Y.titleBaseline),on(K,"fill",Y.titleColor),on(K,"font",Y.titleFont),on(K,"fontSize",Y.titleFontSize),on(K,"fontWeight",Y.titleFontWeight),on(K,"limit",Y.titleLimit),ee.exit={opacity:Q},ee.update={opacity:{value:1},text:Z&&Z.signal?{signal:Z.signal}:{value:Z+""}},l=dn(pn,nn,Dt,null,J,ee,G),s.update.y.offset={field:{group:"titlePadding"},offset:Fn("fontSize",l.encode,n,Dt)},d.push(l)),o=gn("legend",le,re,i,oe,ie,d),e.zindex&&(o.zindex=e.zindex),En(o,n)};function Vn(e){return e&&e.signal||e}function Fn(e,t,n,a){var i=t&&(t.update&&t.update[e]||t.enter&&t.enter[e]);return i&&i.signal?i:i?+i.value:(i=n.config.style[a])&&+i[e]}var An=function(e,n){e=t.isString(e)?{text:e}:e;var a,i,r,o=n.config.title,l=t.extend({},e.encode);return a={orient:null!=e.orient?e.orient:o.orient},i=ye(n.add(Be(null,[a]))),l.name=e.name,l.interactive=e.interactive,r=function(e,n,a,i){var r,o,l,s,u,d,f=e.text,c=e.orient||n.orient,p=e.anchor||n.anchor,g=c===Rt||c===St?-1:1,h=c===St||c===wt,m={group:h?"width":"height"},v={};v.enter=r={opacity:{value:0}},on(r,"fill",n.color),on(r,"font",n.font),on(r,"fontSize",n.fontSize),on(r,"fontWeight",n.fontWeight),v.exit={opacity:{value:0}},v.update=o={opacity:{value:1},text:t.isObject(f)?f:{value:f+""},offset:rn((null!=e.offset?e.offset:n.offset)||0)},"start"===p?(u=0,d="left"):"end"===p?(u=1,d="right"):(u=.5,d="center");l={field:m,mult:u},s=g<0?{value:0}:h?{field:{group:"height"}}:{field:{group:"width"}},h?(o.x=l,o.y=s,o.angle={value:0},o.baseline={value:c===St?"bottom":"top"}):(o.x=s,o.y=l,o.angle={value:90*g},o.baseline={value:"bottom"});return o.align={value:d},o.limit={field:m},on(o,"angle",n.angle),on(o,"baseline",n.baseline),on(o,"limit",n.limit),dn(pn,an,e.style||$t,null,i,v,a)}(e,o,l,i),e.zindex&&(r.zindex=e.zindex),En(r,n)};function Wn(e,n){var a=[];e.transform&&e.transform.forEach(function(e){a.push(vn(e,n))}),e.on&&e.on.forEach(function(t){$n(t,n,e.name)}),n.addDataPipeline(e.name,function(e,n,a){var i,r,o,l,s,u=[],d=null,f=!1,c=!1;e.values?u.push(d=Ln({$ingest:e.values,$format:e.format})):e.url?u.push(d=Ln({$request:e.url,$format:e.format})):e.source&&(d=i=t.array(e.source).map(function(e){return ye(n.getData(e).output)}),u.push(null));for(r=0,o=a.length;r<o;++r)l=a[r],s=l.metadata,d||s.source||u.push(d=Ln()),u.push(l),s.generates&&(c=!0),s.modifies&&!c&&(f=!0),s.source?d=l:s.changes&&(d=null);i&&(o=i.length-1,u[0]=at({derive:f,pulse:o?i:i[0]}),(f||o)&&u.splice(1,0,Ln()));d||u.push(Ln());return u.push(ot({})),u}(e,n,a))}function Ln(e){var t=Be({},e);return t.metadata={source:!0},t}function Cn(e,t){return{scale:e.scale,range:t}}function Mn(e,t,n,a,i){return{signal:'flush(range("'+e+'"), scale("'+e+'", datum.value), '+t+","+n+","+a+","+i+")"}}var qn=function(e,n){var a,i,r,o,l,s,u,d,f,c,p,g,h,m,v,y,b,x,k,S,R,w,O,z,P,j,D,$,E,_,V,F,A,W,L,C,M,q,B,N,U,T,I,X,H,Y,G,J,K,Q,Z,ee,te,ne,ae,ie,re,oe,le,se,ue,de,fe,ce,pe,ge,he,me,ve,be,xe,ke,Se,Re,we,Oe,ze,Pe,De,$e,Ee,_e,Ve,Fe,Ae,We,Le,Ce,qe,Ne,Ue=(u=e,f=(d=n).config,c=u.orient,p=c===St||c===wt?f.axisX:f.axisY,g=f["axis"+c[0].toUpperCase()+c.slice(1)],h="band"===d.scaleType(u.scale)&&f.axisBand,p||g||h?t.extend({},f.axis,p,g,h):f.axis),Te=e.encode||{},Ie=Te.axis||{},Xe=Ie.name||void 0,He=Ie.interactive,Ye=Ie.style;return a={orient:e.orient,ticks:!!je(e.ticks,Ue.ticks),labels:!!je(e.labels,Ue.labels),grid:!!je(e.grid,Ue.grid),domain:!!je(e.domain,Ue.domain),title:!!je(e.title,!1)},i=ye(n.add(Be({},[a]))),Ie=ln({update:{range:{signal:'abs(span(range("'+e.scale+'")))'},offset:rn(je(e.offset,0)),position:rn(je(e.position,0)),titlePadding:rn(je(e.titlePadding,Ue.titlePadding)),minExtent:rn(je(e.minExtent,Ue.minExtent)),maxExtent:rn(je(e.maxExtent,Ue.maxExtent))}},Te.axis,_t),r=ye(n.add(Me({scale:n.scaleRef(e.scale),extra:Ue.tickExtra,count:n.objectProperty(e.tickCount),values:n.objectProperty(e.values),formatSpecifier:n.property(e.format)}))),s=[],a.grid&&s.push((m=e,v=Ue,y=Te.grid,b=r,j=m.orient,D=m.gridScale,E=($=j===Rt||j===St?1:-1)*m.offset||0,(V={}).enter=x={opacity:_={value:0}},on(x,"stroke",v.gridColor),on(x,"strokeWidth",v.gridWidth),on(x,"strokeDash",v.gridDash),V.exit=k={opacity:_},V.update=S={},on(S,"opacity",v.gridOpacity),R={scale:m.scale,field:Pt,band:v.bandPosition,round:v.tickRound,extra:v.tickExtra,offset:v.tickOffset},j===St||j===wt?(w="x",O="y",P="height"):(w="y",O="x",P="width"),z=O+"2",S[w]=x[w]=k[w]=R,D?(x[O]={scale:D,range:0,mult:$,offset:E},S[z]=x[z]={scale:D,range:1,mult:$,offset:E}):(x[O]={value:E},S[z]=x[z]={signal:P,mult:$,offset:E}),dn(cn,Gt,null,Pt,b,V,y))),a.ticks&&(o=je(e.tickSize,Ue.tickSize),s.push((F=e,A=Ue,W=Te.ticks,L=r,C=o,T=F.orient,I=T===Rt||T===St?-1:1,(H={}).enter=M={opacity:X={value:0}},on(M,"stroke",A.tickColor),on(M,"strokeWidth",A.tickWidth),H.exit=q={opacity:X},H.update=B={opacity:{value:1}},(N=rn(C)).mult=I,U={scale:F.scale,field:Pt,band:A.bandPosition,round:A.tickRound,extra:A.tickExtra,offset:A.tickOffset},T===St||T===wt?(B.y=M.y=X,B.y2=M.y2=N,B.x=M.x=q.x=U):(B.x=M.x=X,B.x2=M.x2=N,B.y=M.y=q.y=U),dn(cn,Kt,null,Pt,L,H,W)))),a.labels&&(o=a.ticks?o:0,s.push((Y=e,G=Ue,J=Te.labels,K=r,Q=o,ie=Y.orient,re=ie===Rt||ie===St?-1:1,oe=Y.scale,le=je(Y.labelPadding,G.labelPadding),se=je(Y.labelBound,G.labelBound),ue=je(Y.labelFlush,G.labelFlush),de=null!=ue&&!1!==ue&&(ue=+ue)===ue,fe=+je(Y.labelFlushOffset,G.labelFlushOffset),ce=je(Y.labelOverlap,G.labelOverlap),(ge={}).enter=Z={opacity:pe={value:0}},on(Z,"angle",G.labelAngle),on(Z,"fill",G.labelColor),on(Z,"font",G.labelFont),on(Z,"fontSize",G.labelFontSize),on(Z,"fontWeight",G.labelFontWeight),on(Z,"limit",G.labelLimit),ge.exit=ee={opacity:pe},ge.update=te={opacity:{value:1},text:{field:Ot}},(ne=rn(Q)).mult=re,ne.offset=rn(le),ne.offset.mult=re,ae={scale:oe,field:Pt,band:.5,offset:G.tickOffset},ie===St||ie===wt?(te.y=Z.y=ne,te.x=Z.x=ee.x=ae,on(te,"align",de?Mn(oe,ue,'"left"','"right"','"center"'):"center"),de&&fe&&on(te,"dx",Mn(oe,ue,-fe,fe,0)),on(te,"baseline",ie===St?"bottom":"top")):(te.x=Z.x=ne,te.y=Z.y=ee.y=ae,on(te,"align","right"===ie?"left":"right"),on(te,"baseline",de?Mn(oe,ue,'"bottom"','"top"','"middle"'):"middle"),de&&fe&&on(te,"dy",Mn(oe,ue,fe,-fe,0))),Y=dn(pn,Jt,jt,Pt,K,ge,J),(ce||se)&&(Y.overlap={method:ce,order:"datum.index",bound:se?{scale:oe,orient:ie,tolerance:+se}:null}),Y))),a.domain&&s.push((he=e,me=Ue,ve=Te.domain,be=i,Oe=he.orient,(Pe={}).enter=xe={opacity:ze={value:0}},on(xe,"stroke",me.domainColor),on(xe,"strokeWidth",me.domainWidth),Pe.exit={opacity:ze},Pe.update=ke={opacity:{value:1}},Oe===St||Oe===wt?(Se="x",we="y"):(Se="y",we="x"),Re=Se+"2",xe[we]=ze,ke[Se]=xe[Se]=Cn(he,0),ke[Re]=xe[Re]=Cn(he,1),dn(cn,Yt,null,null,be,Pe,ve))),a.title&&s.push((De=e,$e=Ue,Ee=Te.title,_e=i,We=De.orient,Le=De.title,Ce=We===Rt||We===St?-1:1,qe=We===St||We===wt,(Ne={}).enter=Ve={opacity:{value:0}},on(Ve,"align",$e.titleAlign),on(Ve,"fill",$e.titleColor),on(Ve,"font",$e.titleFont),on(Ve,"fontSize",$e.titleFontSize),on(Ve,"fontWeight",$e.titleFontWeight),on(Ve,"limit",$e.titleLimit),Ne.exit={opacity:{value:0}},Ne.update=Fe={opacity:{value:1},text:Le&&Le.signal?{signal:Le.signal}:{value:Le+""}},Ae={scale:De.scale,range:.5},qe?(Fe.x=Ae,Fe.angle={value:0},Fe.baseline={value:We===St?"bottom":"top"}):(Fe.y=Ae,Fe.angle={value:90*Ce},Fe.baseline={value:"bottom"}),on(Fe,"angle",$e.titleAngle),on(Fe,"baseline",$e.titleBaseline),!on(Fe,"x",$e.titleX)&&qe&&!un("x",Ee)&&(Ne.enter.auto={value:!0}),!on(Fe,"y",$e.titleY)&&!qe&&!un("y",Ee)&&(Ne.enter.auto={value:!0}),dn(pn,Qt,Dt,null,_e,Ne,Ee))),l=gn("axis",Ye,Xe,i,He,Ie,s),e.zindex&&(l.zindex=e.zindex),En(l,n)},Bn=function(e,n,a){var i=t.array(e.signals),r=t.array(e.scales);return a||i.forEach(function(e){y(e,n)}),t.array(e.projections).forEach(function(e){!function(e,t){var n={};for(var a in e)"name"!==a&&(n[a]=kt(e[a],a,t));t.addProjection(e.name,n)}(e,n)}),r.forEach(function(e){var a,i,r;i=n,r=(a=e).type||"linear",ct.hasOwnProperty(r)||t.error("Unrecognized scale type: "+t.stringValue(r)),i.addScale(a.name,{type:r,domain:void 0})}),t.array(e.data).forEach(function(e){Wn(e,n)}),r.forEach(function(e){mt(e,n)}),i.forEach(function(e){We(e,n)}),t.array(e.axes).forEach(function(e){qn(e,n)}),t.array(e.marks).forEach(function(e){En(e,n)}),t.array(e.legends).forEach(function(e){_n(e,n)}),e.title&&An(e.title,n),n.parseLambdas(),n},Nn=t.toSet(["width","height","padding","autosize"]);function Un(e){this.config=e,this.bindings=[],this.field={},this.signals={},this.lambdas={},this.scales={},this.events={},this.data={},this.streams=[],this.updates=[],this.operators=[],this.background=null,this.eventConfig=null,this._id=0,this._subid=0,this._nextsub=[0],this._parent=[],this._encode=[],this._lookup=[],this._markpath=[]}function Tn(e){this.config=e.config,this.field=Object.create(e.field),this.signals=Object.create(e.signals),this.lambdas=Object.create(e.lambdas),this.scales=Object.create(e.scales),this.events=Object.create(e.events),this.data=Object.create(e.data),this.streams=[],this.updates=[],this.operators=[],this._id=0,this._subid=++e._nextsub[0],this._nextsub=e._nextsub,this._parent=e._parent.slice(),this._encode=e._encode.slice(),this._lookup=e._lookup.slice(),this._markpath=e._markpath}var In=Un.prototype=Tn.prototype;function Xn(e){return(t.isArray(e)?function(e){for(var n,a="[",i=0,r=e.length;i<r;++i)n=e[i],a+=(i>0?",":"")+(t.isObject(n)?n.signal||Xn(n):t.stringValue(n));return a+"]"}:function(e){var n,a,i="{",r=0;for(n in e)a=e[n],i+=(++r>1?",":"")+t.stringValue(n)+":"+(t.isObject(a)?a.signal||Xn(a):t.stringValue(a));return i+"}"})(e)}In.fork=function(){return new Tn(this)},In.isSubscope=function(){return this._subid>0},In.toRuntime=function(){return this.finish(),{background:this.background,operators:this.operators,streams:this.streams,updates:this.updates,bindings:this.bindings,eventConfig:this.eventConfig}},In.id=function(){return(this._subid?this._subid+":":0)+this._id++},In.add=function(e){return this.operators.push(e),e.id=this.id(),e.refs&&(e.refs.forEach(function(t){t.$ref=e.id}),e.refs=null),e},In.proxy=function(e){var t=e instanceof he?ye(e):e;return this.add(nt({value:t}))},In.addStream=function(e){return this.streams.push(e),e.id=this.id(),e},In.addUpdate=function(e){return this.updates.push(e),e},In.finish=function(){var e,t;for(e in this.root&&(this.root.root=!0),this.signals)this.signals[e].signal=e;for(e in this.scales)this.scales[e].scale=e;function n(e,t,n){var a;e&&((a=e.data||(e.data={}))[t]||(a[t]=[])).push(n)}for(e in this.data)for(var a in n((t=this.data[e]).input,e,"input"),n(t.output,e,"output"),n(t.values,e,"values"),t.index)n(t.index[a],e,"index:"+a);return this},In.pushState=function(e,t,n){this._encode.push(ye(this.add(ot({pulse:e})))),this._parent.push(t),this._lookup.push(n?ye(this.proxy(n)):null),this._markpath.push(-1)},In.popState=function(){this._encode.pop(),this._parent.pop(),this._lookup.pop(),this._markpath.pop()},In.parent=function(){return t.peek(this._parent)},In.encode=function(){return t.peek(this._encode)},In.lookup=function(){return t.peek(this._lookup)},In.markpath=function(){var e=this._markpath;return++e[e.length-1]},In.fieldRef=function(e,n){if(t.isString(e))return xe(e,n);e.signal||t.error("Unsupported field reference: "+t.stringValue(e));var a,i=e.signal,r=this.field[i];return r||(a={name:this.signalRef(i)},n&&(a.as=n),this.field[i]=r=ye(this.add(Xe(a)))),r},In.compareRef=function(e,n){function a(e){return Pe(e)?(r=!0,ye(i[e.signal])):e}var i=this.signals,r=!1,o=t.array(e.field).map(a),l=t.array(e.order).map(a);return n&&o.push(be),r?ye(this.add(Ne({fields:o,orders:l}))):Se(o,l)},In.keyRef=function(e,n){var a,i=this.signals,r=!1;return e=t.array(e).map(function(e){return Pe(e)?(r=!0,ye(i[e.signal])):e}),r?ye(this.add(He({fields:e,flat:n}))):(a={$key:e},n&&(a.$flat=!0),a)},In.sortRef=function(e){if(!e)return e;var t=[we(e.op,e.field),be],n=e.order||"ascending";return n.signal?ye(this.add(Ne({fields:t,orders:[n=this.signalRef(n.signal),n]}))):Se(t,[n,n])},In.event=function(e,t){var n=e+":"+t;if(!this.events[n]){var a=this.id();this.streams.push({id:a,source:e,type:t}),this.events[n]=a}return this.events[n]},In.addSignal=function(e,n){this.signals.hasOwnProperty(e)&&t.error("Duplicate signal name: "+t.stringValue(e));var a=n instanceof he?n:this.add(ve(n));return this.signals[e]=a},In.getSignal=function(e){return this.signals[e]||t.error("Unrecognized signal name: "+t.stringValue(e)),this.signals[e]},In.signalRef=function(e){return this.signals[e]?ye(this.signals[e]):(this.lambdas.hasOwnProperty(e)||(this.lambdas[e]=this.add(ve(null))),ye(this.lambdas[e]))},In.parseLambdas=function(){for(var e=Object.keys(this.lambdas),t=0,n=e.length;t<n;++t){var a=e[t],i=ge(a,this),r=this.lambdas[a];r.params=i.$params,r.update=i.$expr}},In.property=function(e){return e&&e.signal?this.signalRef(e.signal):e},In.objectProperty=function(e){return e&&t.isObject(e)?this.signalRef(e.signal||Xn(e)):e},In.addBinding=function(e,n){this.bindings||t.error("Nested signals do not support binding: "+t.stringValue(e)),this.bindings.push(t.extend({signal:e},n))},In.addScaleProj=function(e,n){this.scales.hasOwnProperty(e)&&t.error("Duplicate scale or projection name: "+t.stringValue(e)),this.scales[e]=this.add(n)},In.addScale=function(e,t){this.addScaleProj(e,rt(t))},In.addProjection=function(e,t){this.addScaleProj(e,tt(t))},In.getScale=function(e){return this.scales[e]||t.error("Unrecognized scale name: "+t.stringValue(e)),this.scales[e]},In.projectionRef=In.scaleRef=function(e){return ye(this.getScale(e))},In.projectionType=In.scaleType=function(e){return this.getScale(e).params.type},In.addData=function(e,n){return this.data.hasOwnProperty(e)&&t.error("Duplicate data set name: "+t.stringValue(e)),this.data[e]=n},In.getData=function(e){return this.data[e]||t.error("Undefined data set name: "+t.stringValue(e)),this.data[e]},In.addDataPipeline=function(e,n){return this.data.hasOwnProperty(e)&&t.error("Duplicate data set name: "+t.stringValue(e)),this.addData(e,On.fromEntries(this,n))};var Hn=function(e){var n={padding:0,autosize:"pad",background:null,events:{defaults:{allow:["wheel"]}},group:null,mark:null,arc:{fill:Kn},area:{fill:Kn},image:null,line:{stroke:Kn,strokeWidth:Jn},path:{stroke:Kn},rect:{fill:Kn},rule:{stroke:Qn},shape:{stroke:Kn},symbol:{fill:Kn,size:64},text:{fill:Qn,font:Yn,fontSize:11},style:{"guide-label":{fill:Qn,font:Yn,fontSize:10},"guide-title":{fill:Qn,font:Yn,fontSize:11,fontWeight:"bold"},"group-title":{fill:Qn,font:Yn,fontSize:13,fontWeight:"bold"},point:{size:Gn,strokeWidth:Jn,shape:"circle"},circle:{size:Gn,strokeWidth:Jn},square:{size:Gn,strokeWidth:Jn,shape:"square"},cell:{fill:"transparent",stroke:ea}},axis:{minExtent:0,maxExtent:200,bandPosition:.5,domain:!0,domainWidth:1,domainColor:Zn,grid:!1,gridWidth:1,gridColor:ea,gridOpacity:1,labels:!0,labelAngle:0,labelLimit:180,labelPadding:2,ticks:!0,tickColor:Zn,tickOffset:0,tickRound:!0,tickSize:5,tickWidth:1,titleAlign:"center",titlePadding:4},axisBand:{tickOffset:-1},legend:{orient:"right",offset:18,padding:0,entryPadding:5,titlePadding:5,gradientWidth:100,gradientHeight:20,gradientStrokeColor:ea,gradientStrokeWidth:0,gradientLabelBaseline:"top",gradientLabelOffset:2,labelAlign:"left",labelBaseline:"middle",labelOffset:8,labelLimit:160,symbolType:"circle",symbolSize:100,symbolFillColor:"transparent",symbolStrokeColor:Zn,symbolStrokeWidth:1.5,titleAlign:"left",titleBaseline:"top",titleLimit:180},title:{orient:"top",anchor:"middle",offset:4},range:{category:{scheme:"tableau10"},ordinal:{scheme:"blues",extent:[.2,1]},heatmap:{scheme:"viridis"},ramp:{scheme:"blues",extent:[.2,1]},diverging:{scheme:"blueorange"},symbol:["circle","square","triangle-up","cross","diamond","triangle-right","triangle-down","triangle-left"]}};return(e||[]).forEach(function(e){var a,i,r;if(e)for(a in e)if("style"===a)for(a in r=n.style||(n.style={}),e.style)r[a]=t.extend(r[a]||{},e.style[a]);else i=e[a],n[a]=t.isObject(i)&&!t.isArray(i)?t.extend(t.isObject(n[a])?n[a]:{},i):i}),n},Yn="sans-serif",Gn=30,Jn=2,Kn="#4c78a8",Qn="#000",Zn="#888",ea="#ddd";e.parse=function(e,n){return t.isObject(e)||t.error("Input Vega specification must be an object."),(a=e,i=new Un(Hn([n,e.config])),d=i.config,i.background=a.background||d.background,i.eventConfig=d.events,u=ye(i.root=i.add(ve())),i.addSignal("width",a.width||0),i.addSignal("height",a.height||0),i.addSignal("padding",g(a.padding,d)),i.addSignal("autosize",p(a.autosize,d)),t.array(a.signals).forEach(function(e){Nn[e.name]||y(e,i)}),o=i.add(Be()),l=ln({enter:{x:{value:0},y:{value:0}},update:{width:{signal:"width"},height:{signal:"height"}}},a.encode),l=i.add(Te(sn(l,fn,Xt,a.style,i,{pulse:ye(o)}))),s=i.add(st({layout:i.objectProperty(a.layout),legendMargin:d.legendMargin,autosize:i.signalRef("autosize"),mark:u,pulse:ye(l)})),i.operators.pop(),i.pushState(ye(l),ye(s),null),Bn(a,i,!0),i.operators.push(s),r=i.add(qe({mark:u,pulse:ye(s)})),r=i.add(it({pulse:ye(r)})),r=i.add(ot({pulse:ye(r)})),i.addData("root",new On(i,o,o,r)),i).toRuntime();var a,i,r,o,l,s,u,d},e.config=Hn,e.signal=y,e.signalUpdates=We,e.stream=De,e.codeGenerator=pe,e.functionContext=oe,e.expressionFunction=fe,e.MarkRole=It,e.FrameRole=Xt,e.ScopeRole=Ht,e.AxisRole="axis",e.AxisDomainRole=Yt,e.AxisGridRole=Gt,e.AxisLabelRole=Jt,e.AxisTickRole=Kt,e.AxisTitleRole=Qt,e.LegendRole="legend",e.LegendEntryRole=Zt,e.LegendLabelRole=en,e.LegendSymbolRole=tn,e.LegendTitleRole=nn,e.Scope=Un,e.DataScope=On,e.formatLocale=l.formatDefaultLocale,e.timeFormatLocale=s.timeFormatDefaultLocale,Object.defineProperty(e,"__esModule",{value:!0})});