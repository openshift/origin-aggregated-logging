!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("vega-scale"),require("vega-util"),require("d3-format"),require("vega-dataflow"),require("d3-array"),require("d3-interpolate")):"function"==typeof define&&define.amd?define(["exports","vega-scale","vega-util","d3-format","vega-dataflow","d3-array","d3-interpolate"],n):n((e.vega=e.vega||{},e.vega.transforms=e.vega.transforms||{}),e.vega,e.vega,e.d3,e.vega,e.d3,e.d3)}(this,function(e,p,M,u,h,g,i){"use strict";var x="log",k="pow",S="sqrt",o="band",s="point",l="linear",O="ordinal",f="quantile",c="quantize",d="threshold",m="bin-ordinal",v="sequential";function b(e,n){var t;return M.isObject(n)&&(t=n.step,n=n.interval),M.isString(n)&&(n="time"===e.type?p.timeInterval(n):"utc"===e.type?p.utcInterval(n):M.error("Only time and utc scales accept interval strings."),t&&(n=n.every(t))),n}function y(n,e,t){var r=n.range(),a=r[0],i=M.peek(r);if(i<a&&(r=i,i=a,a=r),e=e.filter(function(e){return!((e=n(e))<a||i<e)}),0<t&&1<e.length){for(var o=[e[0],M.peek(e)];e.length>t&&3<=e.length;)e=e.filter(function(e,n){return!(n%2)});e.length<3&&(e=o)}return e}function A(e,n){return e.ticks?e.ticks(n):e.domain()}function D(e,n,t){var r,a,i=e.tickFormat?e.tickFormat(n,t):String;return e.type===x?(r=i,a=function(e){var n=u.formatSpecifier(e||",");{if(null==n.precision){switch(n.precision=12,n.type){case"%":n.precision-=2;break;case"e":n.precision-=1}return i=u.format(n),o=u.format(".1f")(1)[1],function(e){var n,t,r=i(e),a=r.indexOf(o);if(a<0)return r;for(n=function(e,n){var t,r=e.lastIndexOf("e");if(0<r)return r;for(r=e.length;--r>n;)if(48<=(t=e.charCodeAt(r))&&t<=57)return r+1}(r,a),t=n<r.length?r.slice(n):"";--n>a;)if("0"!==r[n]){++n;break}return r.slice(0,n)+t}}return u.format(n)}var i,o}(t),function(e){return r(e)?a(e):""}):i}function n(e){h.Transform.call(this,null,e)}function t(e){h.Transform.call(this,null,e)}function w(){return h.ingest({})}function T(e){return e.exit}function r(e){h.Transform.call(this,null,e)}M.inherits(n,h.Transform).transform=function(e,n){if(this.value&&!e.modified())return n.StopPropagation;var t=n.fork(n.NO_SOURCE|n.NO_FIELDS),r=this.value,a=e.scale,i=null==e.count?e.values?e.values.length:10:b(a,e.count),o=e.format||D(a,i,e.formatSpecifier),u=e.values?y(a,e.values,i):A(a,i);return r&&(t.rem=r),r=u.map(function(e,n){return h.ingest({index:n/(u.length-1),value:e,label:o(e)})}),e.extra&&r.push(h.ingest({index:-1,extra:{value:r[0].value},label:""})),t.source=r,t.add=r,this.value=r,t},M.inherits(t,h.Transform).transform=function(e,n){var t=n.dataflow,r=n.fork(n.NO_SOURCE|n.NO_FIELDS),a=e.item||w,i=e.key||h.tupleid,o=this.value;return M.isArray(r.encode)&&(r.encode=null),o&&(e.modified("key")||n.modified(i))&&M.error("DataJoin does not support modified key function or fields."),o||(n=n.addAll(),this.value=o=M.fastmap().test(T),o.lookup=function(e){return o.get(i(e))}),n.visit(n.ADD,function(e){var n=i(e),t=o.get(n);t?t.exit?(o.empty--,r.add.push(t)):r.mod.push(t):(o.set(n,t=a(e)),r.add.push(t)),t.datum=e,t.exit=!1}),n.visit(n.MOD,function(e){var n=i(e),t=o.get(n);t&&(t.datum=e,r.mod.push(t))}),n.visit(n.REM,function(e){var n=i(e),t=o.get(n);e!==t.datum||t.exit||(r.rem.push(t),t.exit=!0,++o.empty)}),n.changed(n.ADD_MOD)&&r.modifies("datum"),e.clean&&o.empty>t.cleanThreshold&&t.runAfter(o.clean),r},M.inherits(r,h.Transform).transform=function(t,e){var r=e.fork(e.ADD_REM),n=t.encoders,a=e.encode;if(M.isArray(a)){if(!r.changed()&&!a.every(function(e){return n[e]}))return e.StopPropagation;a=a[0],r.encode=null}var i="enter"===a,o=n.update||M.falsy,u=n.enter||M.falsy,s=n.exit||M.falsy,l=(a&&!i?n[a]:o)||M.falsy;if(e.changed(e.ADD)&&(e.visit(e.ADD,function(e){u(e,t),o(e,t),l!==M.falsy&&l!==o&&l(e,t)}),r.modifies(u.output),r.modifies(o.output),l!==M.falsy&&l!==o&&r.modifies(l.output)),e.changed(e.REM)&&s!==M.falsy&&(e.visit(e.REM,function(e){s(e,t)}),r.modifies(s.output)),i||l!==M.falsy){var f=e.MOD|(t.modified()?e.REFLOW:0);i?(e.visit(f,function(e){var n=u(e,t);(l(e,t)||n)&&r.mod.push(e)}),r.mod.length&&r.modifies(u.output)):e.visit(f,function(e){l(e,t)&&r.mod.push(e)}),r.mod.length&&r.modifies(l.output)}return r.changed()?r:e.StopPropagation};var z={};function a(e){var n=e.domain();return n.max=n.pop(),n}function E(e,n){return z[e.type]?(o=n,function(e,n,t){var r=t[n+1]||t.max||1/0,a=F(e,o),i=F(r,o);return a&&i?a+"–"+i:i?"< "+i:"≥ "+a}):(t=n,function(e){return t(e)});var t,o}function F(e,n){return isFinite(e)?n(e):null}function R(e){h.Transform.call(this,[],e)}z[f]=function(e){var n=[-1/0].concat(e.quantiles());return n.max=1/0,n},z[c]=function(e){var n=e.domain(),t=n[0],r=M.peek(n),a=e.range().length,i=new Array(a),o=0;i[0]=-1/0;for(;++o<a;)i[o]=(o*r-(o-a)*t)/a;return i.max=1/0,i},z[d]=function(e){var n=[-1/0].concat(e.domain());return n.max=1/0,n},z["bin-linear"]=a,z[m]=a,M.inherits(R,h.Transform).transform=function(r,e){if(null!=this.value&&!r.modified())return e.StopPropagation;var n=e.fork(e.NO_SOURCE|e.NO_FIELDS),a=0,t=this.value,i="gradient"===r.type,o=r.scale,u=null==r.count?5:b(o,r.count),s=r.format||D(o,u,r.formatSpecifier),l=r.values||function(e,n,t){if(t)return e.domain();var r=z[e.type];return r?r(e):A(e,n)}(o,u,i);if(s=E(o,s),t&&(n.rem=t),i)var f=r.values?o.domain():l,c=p.scaleFraction(o,f[0],M.peek(f));else{var d,m=r.size;M.isFunction(m)?(r.values||0!==o(l[0])||(l=l.slice(1)),d=l.reduce(function(e,n){return Math.max(e,m(n,r))},0)):m=M.constant(d=m||8)}return t=l.map(function(e,n){var t=h.ingest({index:n,label:s(e,n,l),value:e});return i?t.perc=c(e):(t.offset=d,t.size=m(e,r),t.total=Math.round(a),a+=t.size),t}),n.source=t,n.add=t,this.value=t,n};var C=M.fastmap({line:N,"line-radial":function(e,n,t,r){return N(n*Math.cos(e),n*Math.sin(e),r*Math.cos(t),r*Math.sin(t))},arc:U,"arc-radial":function(e,n,t,r){return U(n*Math.cos(e),n*Math.sin(e),r*Math.cos(t),r*Math.sin(t))},curve:j,"curve-radial":function(e,n,t,r){return j(n*Math.cos(e),n*Math.sin(e),r*Math.cos(t),r*Math.sin(t))},"orthogonal-horizontal":function(e,n,t,r){return"M"+e+","+n+"V"+r+"H"+t},"orthogonal-vertical":function(e,n,t,r){return"M"+e+","+n+"H"+t+"V"+r},"orthogonal-radial":function(e,n,t,r){var a=Math.cos(e),i=Math.sin(e),o=Math.cos(t),u=Math.sin(t),s=Math.abs(t-e)>Math.PI?t<=e:e<t;return"M"+n*a+","+n*i+"A"+n+","+n+" 0 0,"+(s?1:0)+" "+n*o+","+n*u+"L"+r*o+","+r*u},"diagonal-horizontal":function(e,n,t,r){var a=(e+t)/2;return"M"+e+","+n+"C"+a+","+n+" "+a+","+r+" "+t+","+r},"diagonal-vertical":function(e,n,t,r){var a=(n+r)/2;return"M"+e+","+n+"C"+e+","+a+" "+t+","+a+" "+t+","+r},"diagonal-radial":function(e,n,t,r){var a=Math.cos(e),i=Math.sin(e),o=Math.cos(t),u=Math.sin(t),s=(n+r)/2;return"M"+n*a+","+n*i+"C"+s*a+","+s*i+" "+s*o+","+s*u+" "+r*o+","+r*u}});function L(e){return e.source.x}function P(e){return e.source.y}function q(e){return e.target.x}function I(e){return e.target.y}function _(e){h.Transform.call(this,{},e)}function N(e,n,t,r){return"M"+e+","+n+"L"+t+","+r}function U(e,n,t,r){var a=t-e,i=r-n,o=Math.sqrt(a*a+i*i)/2;return"M"+e+","+n+"A"+o+","+o+" "+180*Math.atan2(i,a)/Math.PI+" 0 1 "+t+","+r}function j(e,n,t,r){var a=t-e,i=r-n,o=.2*(a+i),u=.2*(i-a);return"M"+e+","+n+"C"+(e+o)+","+(n+u)+" "+(t+u)+","+(r-o)+" "+t+","+r}function X(e){h.Transform.call(this,null,e)}_.Definition={type:"LinkPath",metadata:{modifies:!0},params:[{name:"sourceX",type:"field",default:"source.x"},{name:"sourceY",type:"field",default:"source.y"},{name:"targetX",type:"field",default:"target.x"},{name:"targetY",type:"field",default:"target.y"},{name:"orient",type:"enum",default:"vertical",values:["horizontal","vertical","radial"]},{name:"shape",type:"enum",default:"line",values:["line","arc","curve","diagonal","orthogonal"]},{name:"as",type:"string",default:"path"}]},M.inherits(_,h.Transform).transform=function(e,n){var t=e.sourceX||L,r=e.sourceY||P,a=e.targetX||q,i=e.targetY||I,o=e.as||"path",u=e.orient||"vertical",s=e.shape||"line",l=C.get(s+"-"+u)||C.get(s);return l||M.error("LinkPath unsupported type: "+e.shape+(e.orient?"-"+e.orient:"")),n.visit(n.SOURCE,function(e){e[o]=l(t(e),r(e),a(e),i(e))}),n.reflow(e.modified()).modifies(o)},X.Definition={type:"Pie",metadata:{modifies:!0},params:[{name:"field",type:"field"},{name:"startAngle",type:"number",default:0},{name:"endAngle",type:"number",default:6.283185307179586},{name:"sort",type:"boolean",default:!1},{name:"as",type:"string",array:!0,length:2,default:["startAngle","endAngle"]}]},M.inherits(X,h.Transform).transform=function(e,n){var t,r,a,i=e.as||["startAngle","endAngle"],o=i[0],u=i[1],s=e.field||M.one,l=e.startAngle||0,f=null!=e.endAngle?e.endAngle:2*Math.PI,c=n.source,d=c.map(s),m=d.length,p=l,h=(f-l)/g.sum(d),v=g.range(m);for(e.sort&&v.sort(function(e,n){return d[e]-d[n]}),t=0;t<m;++t)a=d[v[t]],(r=c[v[t]])[o]=p,r[u]=p+=a*h;return this.value=d,n.reflow(e.modified()).modifies(i)};var Y=5,G=M.toSet([l,k,S]),H=M.toSet([l,x,k,S,"time","utc"]),V=M.toSet(["set","modified","clear","type","scheme","schemeExtent","schemeCount","domain","domainMin","domainMid","domainMax","domainRaw","nice","zero","range","rangeStep","round","reverse","interpolate","interpolateGamma"]);function B(e){h.Transform.call(this,null,e),this.modified(!0)}function J(e,n,t){return M.isFunction(e)&&(n||t)?p.interpolateRange(e,W(n||[0,1],t)):e}function W(e,n){return n?e.slice().reverse():e}function K(e){h.Transform.call(this,null,e)}M.inherits(B,h.Transform).transform=function(e,n){var t,r=n.dataflow,a=this.value;for(t in a&&!e.modified("type")||(this.value=a=p.scale((e.type||l).toLowerCase())()),e)if(!V[t]){if("padding"===t&&H[a.type])continue;M.isFunction(a[t])?a[t](e[t]):r.warn("Unsupported scale property: "+t)}return function(e,n,t){var r=n.round||!1,a=n.range;if(null!=n.rangeStep)a=function(e,n,t){e!==o&&e!==s&&M.error("Only band and point scales support rangeStep.");var r=(null!=n.paddingOuter?n.paddingOuter:n.padding)||0,a=e===s?1:(null!=n.paddingInner?n.paddingInner:n.padding)||0;return[0,n.rangeStep*p.bandSpace(t,a,r)]}(e.type,n,t);else if(n.scheme){if(a=function(e,n,t){var r,a=n.scheme.toLowerCase(),i=p.scheme(a),o=n.schemeExtent;i||M.error("Unrecognized scheme name: "+n.scheme);return t=e===d?t+1:e===m?t-1:e===f||e===c?+n.schemeCount||Y:t,e===v?J(i,o,n.reverse):!o&&(r=p.scheme(a+"-"+t))?r:M.isFunction(i)?function(e,n){for(var t=new Array(n),r=n-1||1,a=0;a<n;++a)t[a]=e(a/r);return t}(J(i,o),t):e===O?i:i.slice(0,t)}(e.type,n,t),M.isFunction(a))return e.interpolator(a)}else if(a&&e.type===v)return e.interpolator(i.interpolateRgbBasis(W(a,n.reverse)));a&&n.interpolate&&e.interpolate?e.interpolate(p.interpolate(n.interpolate,n.interpolateGamma)):M.isFunction(e.round)?e.round(r):M.isFunction(e.rangeRound)&&e.interpolate(r?i.interpolateRound:i.interpolate);a&&e.range(W(a,n.reverse))}(a,e,function(e,n,t){var r=(a=e,i=n.domainRaw,i?(a.domain(i),i.length):-1);var a,i;if(-1<r)return r;var o,u,s=n.domain,l=e.type,f=n.zero||void 0===n.zero&&G[l];if(!s)return 0;H[l]&&n.padding&&s[0]!==M.peek(s)&&(c=l,d=s,m=n.range,p=n.padding,h=n.exponent,v=Math.abs(M.peek(m)-m[0]),g=v/(v-2*p),y=c===x?M.zoomLog(d,null,g):c===S?M.zoomPow(d,null,g,.5):c===k?M.zoomPow(d,null,g,h):M.zoomLinear(d,null,g),(d=d.slice())[0]=y[0],d[d.length-1]=y[1],s=d);var c,d,m,p,h,v,g,y;(f||null!=n.domainMin||null!=n.domainMax||null!=n.domainMid)&&(o=(s=s.slice()).length-1||1,f&&(0<s[0]&&(s[0]=0),s[o]<0&&(s[o]=0)),null!=n.domainMin&&(s[0]=n.domainMin),null!=n.domainMax&&(s[o]=n.domainMax),null!=n.domainMid&&(((u=n.domainMid)<s[0]||u>s[o])&&t.warn("Scale domainMid exceeds domain min or max.",u),s.splice(o,0,u)));e.domain(s),l===O&&e.unknown(void 0);n.nice&&e.nice&&e.nice(!0!==n.nice&&b(e,n.nice)||null);return s.length}(a,e,r)),n.fork(n.NO_SOURCE|n.NO_FIELDS)},M.inherits(K,h.Transform).transform=function(e,n){var t=e.modified("sort")||n.changed(n.ADD)||n.modified(e.sort.fields)||n.modified("datum");return t&&n.source.sort(e.sort),this.modified(t),n};function Q(e){h.Transform.call(this,null,e)}function Z(e,n,t,r,a){for(var i,o=(n-e.sum)/2,u=e.length,s=0;s<u;++s)(i=e[s])[r]=o,i[a]=o+=Math.abs(t(i))}function $(e,n,t,r,a){for(var i,o=1/e.sum,u=0,s=e.length,l=0,f=0;l<s;++l)(i=e[l])[r]=u,i[a]=u=o*(f+=Math.abs(t(i)))}function ee(e,n,t,r,a){for(var i,o,u=0,s=0,l=e.length,f=0;f<l;++f)(i=t(o=e[f]))<0?(o[r]=s,o[a]=s+=i):(o[r]=u,o[a]=u+=i)}Q.Definition={type:"Stack",metadata:{modifies:!0},params:[{name:"field",type:"field"},{name:"groupby",type:"field",array:!0},{name:"sort",type:"compare"},{name:"offset",type:"enum",default:"zero",values:["zero","center","normalize"]},{name:"as",type:"string",array:!0,length:2,default:["y0","y1"]}]},M.inherits(Q,h.Transform).transform=function(e,n){var t,r,a,i,o=e.as||["y0","y1"],u=o[0],s=o[1],l=e.field||M.one,f="center"===e.offset?Z:"normalize"===e.offset?$:ee;for(r=0,a=(t=function(e,n,t,r){var a,i,o,u,s,l,f,c,d,m=[],p=function(e){return e(s)};if(null==n)m.push(e.slice());else for(a={},i=0,o=e.length;i<o;++i)s=e[i],l=n.map(p),(f=a[l])||(a[l]=f=[],m.push(f)),f.push(s);for(d=l=0,u=m.length;l<u;++l){for(f=m[l],c=i=0,o=f.length;i<o;++i)c+=Math.abs(r(f[i]));f.sum=c,d<c&&(d=c),t&&f.sort(t)}return m.max=d,m}(n.source,e.groupby,e.sort,l)).length,i=t.max;r<a;++r)f(t[r],i,l,u,s);return n.reflow(e.modified()).modifies(o)},e.axisticks=n,e.datajoin=t,e.encode=r,e.legendentries=R,e.linkpath=_,e.pie=X,e.scale=B,e.sortitems=K,e.stack=Q,e.validTicks=y,Object.defineProperty(e,"__esModule",{value:!0})});