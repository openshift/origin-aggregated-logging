<source>
  @type tail
  path /var/log/audit/audit-ocp.log
  pos_file /var/log/audit/audit-ocp.pos
  # From 3.9, the advanced audits logs comes in json format by default.
  format json
  tag audit-ocp.log
</source>

<match audit-ocp.log>
  # @type stdout
   @type copy
  <store>
    @type elasticsearch_dynamic
    log_level debug
    host "#{ENV['OPS_HOST']}"
    port "#{ENV['OPS_PORT']}"
    scheme https
    index_name operations.ocp.auditlog.
    
    user fluentd
    password changeme

    client_key "#{ENV['OPS_CLIENT_KEY']}"
    client_cert "#{ENV['OPS_CLIENT_CERT']}"
    ca_file "#{ENV['OPS_CA']}"

    type_name com.redhat.ocp.auditlog

    reload_connections "#{ENV['OPS_RELOAD_CONNECTIONS'] || ENV['ES_RELOAD_CONNECTIONS'] || 'true'}"
    # https://github.com/uken/fluent-plugin-elasticsearch#sniffer-class-name
    reload_after "#{ENV['OPS_RELOAD_AFTER'] || ENV['ES_RELOAD_AFTER'] || '200'}"
    # https://github.com/uken/fluent-plugin-elasticsearch#reload-after
    flush_interval "#{ENV['OPS_FLUSH_INTERVAL'] || ENV['ES_FLUSH_INTERVAL'] || '1s'}"
    max_retry_wait "#{ENV['OPS_RETRY_WAIT'] || ENV['ES_RETRY_WAIT'] || '300'}"
    disable_retry_limit true
    buffer_queue_limit "#{ENV['BUFFER_QUEUE_LIMIT'] || '1024' }"
    buffer_chunk_limit "#{ENV['BUFFER_SIZE_LIMIT'] || '1m' }"
    # the systemd journald 0.0.8 input plugin will just throw away records if the buffer
    # queue limit is hit - 'block' will halt further reads and keep retrying to flush the
    # buffer to the remote - default is 'exception' because in_tail handles that case
    buffer_queue_full_action "#{ENV['BUFFER_QUEUE_FULL_ACTION'] || 'exception'}"
  </store>
</match>
